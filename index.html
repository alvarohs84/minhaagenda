<!DOCTYPE html>
<html lang='pt-br'>
<head>
    <meta charset='utf-8' />
    <title>Agenda de Fisioterapia</title>
    
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding: 20px;
        }
        #calendar {
            max-width: 1100px;
            margin: 0 auto;
        }
        .fc-event {
            cursor: pointer;
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1100px;
            margin: 0 auto;
            margin-bottom: 20px;
        }
        .header-controls button {
            font-size: 0.9em;
            padding: 10px 15px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            color: white;
            font-weight: bold;
            margin-left: 10px;
        }
        #btn-abrir-modal-paciente {
            background-color: #17a2b8;
        }
        #btn-abrir-dashboard {
            background-color: #6f42c1;
        }
        #btn-abrir-lista-pacientes {
            background-color: #28a745;
        }
        
        #btn-cadastro-rapido-voz {
            background-color: #fd7e14; /* Laranja */
        }

        .modal-container {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            border-radius: 8px;
            padding: 25px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-content h3, .modal-content h4 {
            margin-top: 0;
        }
        .modal-content textarea {
            width: 95%;
            height: 150px;
            font-size: 1.1em;
            margin-top: 10px;
        }
        .modal-content button {
            font-size: 1em;
            padding: 10px 15px;
            margin-top: 15px;
            margin-right: 10px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
        }
        
        #btn-checkin { background-color: #28a745; color: white; }
        #btn-cancelar { background-color: #ffc107; color: black; } 
        #btn-gravar { background-color: #dc3545; color: white; }
        #btn-salvar-evolucao { background-color: #007bff; color: white; }
        #status-gravacao { font-style: italic; color: #555; }

        .modal-content form { 
            display: flex; 
            flex-direction: column; 
        }
        .modal-content form label { 
            margin-top: 15px; 
            font-weight: bold; 
            font-size: 0.9em;
        }
        .modal-content form input,
        .modal-content form select,
        .modal-content form textarea#paciente-diag {
            width: 95%;
            padding: 8px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-top: 5px;
            height: auto;
        }
        #btn-salvar-paciente { 
            background-color: #007bff; 
            color: white; 
            margin-top: 20px;
        }

        .modal-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .modal-table th, .modal-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .modal-table th {
            background-color: #f2f2f2;
        }
        
        #lista-pacientes-tbody tr {
            cursor: pointer;
        }
        #lista-pacientes-tbody tr:hover {
            background-color: #f5f5f5;
        }

        /* [NOVO] Estilo para os bot√µes de a√ß√£o */
        .btn-acao {
            padding: 5px 8px;
            font-size: 0.9em;
            margin-right: 5px;
        }
        .btn-acao-edit {
            background-color: #ffc107; /* Amarelo */
            color: black;
        }
        .btn-acao-delete {
            background-color: #dc3545; /* Vermelho */
            color: white;
        }
        
        #historico-evolucoes-content .evolucao-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
            margin-bottom: 10px;
        }
        #historico-evolucoes-content .evolucao-item:last-child {
            border-bottom: none;
        }
        #historico-evolucoes-content .evolucao-data {
            font-weight: bold;
            font-size: 0.9em;
            color: #555;
        }
        #historico-evolucoes-content .evolucao-texto {
            font-size: 1em;
            margin-top: 5px;
            white-space: pre-wrap;
        }
        #loading-dashboard, #loading-historico {
            display: none;
            font-style: italic;
        }

        #dashboard-filtros {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }
        #dashboard-filtros select, #dashboard-filtros button {
            padding: 8px;
            font-size: 1em;
            margin-top: 0;
        }
    </style>
</head>
<body>

    <div class="header-controls">
        <h2>Minha Agenda de Fisioterapia</h2>
        <div>
            <button id="btn-abrir-lista-pacientes">Ver Pacientes üìã</button>
            <button id="btn-abrir-dashboard">Dashboard üìä</button>
            <button id="btn-abrir-modal-paciente">Cadastrar Novo Paciente +</button>
            <button id="btn-cadastro-rapido-voz">Cadastrar por Voz üé§</button>
        </div>
    </div>

    <div id='calendar'></div>

    <div id="modal-container" class="modal-container">
        <div class="modal-content">
            <span class="modal-close" id="modal-agendamento-close">&times;</span>
            <h3 id="modal-paciente-nome">Nome do Paciente</h3>
            <p><strong>Diagn√≥stico:</strong> <span id="modal-paciente-diagnostico"></span></p>
            <p><strong>Telefone:</strong> <span id="modal-paciente-telefone"></span></p>
            <p><strong>Status:</strong> <span id="modal-agendamento-status"></span></p>
            <button id="btn-checkin">Fazer Check-in</button>
            <button id="btn-cancelar">Cancelar Atendimento</button>
            <hr style="margin-top: 20px;">
            <h4>Evolu√ß√£o da Sess√£o</h4>
            <textarea id="texto-evolucao" placeholder="Digite ou grave a evolu√ß√£o..."></textarea>
            <p id="status-gravacao"></p>
            <button id="btn-gravar">Gravar üé§</button>
            <button id="btn-salvar-evolucao">Salvar Evolu√ß√£o</button>
        </div>
    </div>
    
    <div id="modal-paciente-container" class="modal-container">
        <div class="modal-content">
            <span class="modal-close" id="modal-paciente-close">&times;</span>
            <h3 id="modal-titulo-paciente">Cadastrar Novo Paciente</h3> <form id="form-novo-paciente">
                <label for="paciente-nome">Nome Completo:</label>
                <input type="text" id="paciente-nome" required>
                
                <label for="paciente-telefone">Telefone:</label>
                <input type="text" id="paciente-telefone" placeholder="(XX) 9XXXX-XXXX">
                
                <label for="paciente-nasc">Data de Nascimento:</label>
                <input type="date" id="paciente-nasc">
                
                <label for="paciente-sexo">Sexo:</label>
                <select id="paciente-sexo">
                    <option value="">Selecione...</option> 
                    <option value="Feminino">Feminino</option>
                    <option value="Masculino">Masculino</option>
                    <option value="Outro">Outro</option>
                </select>
                
                <label for="paciente-diag">Diagn√≥stico M√©dico:</label>
                <textarea id="paciente-diag" rows="3"></textarea>
                
                <button type="submit" id="btn-salvar-paciente">Salvar Paciente</button>
            </form>
        </div>
    </div>

    <div id="modal-dashboard-container" class="modal-container">
        <div class="modal-content">
            <span class="modal-close" id="modal-dashboard-close">&times;</span>
            <h3>Dashboard de Sess√µes Realizadas</h3>
            <div id="dashboard-filtros">
                <label for="dash-mes">M√™s:</label>
                <select id="dash-mes"></select>
                <label for="dash-ano">Ano:</label>
                <select id="dash-ano"></select>
                <button id="btn-buscar-dashboard">Buscar</button>
            </div>
            <p id="loading-dashboard">Carregando dados...</p>
            <div id="dashboard-resultados">
                <table class="modal-table">
                </table>
            </div>
        </div>
    </div>
    
    <div id="modal-lista-pacientes-container" class="modal-container">
        <div class="modal-content">
            <span class="modal-close" id="modal-lista-pacientes-close">&times;</span>
            <h3>Pacientes Cadastrados</h3>
            <p style="font-size: 0.9em; color: #555;">Clique em um paciente para ver seu hist√≥rico de evolu√ß√µes.</p>
            <div id="lista-pacientes-resultados">
                <table class="modal-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Telefone</th>
                            <th>A√ß√µes</th> </tr>
                    </thead>
                    <tbody id="lista-pacientes-tbody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="modal-historico-container" class="modal-container">
        <div class="modal-content">
            <span class="modal-close" id="modal-historico-close">&times;</span>
            <h3>Hist√≥rico de <span id="historico-nome-paciente"></span></h3>
            <p id="loading-historico">Carregando hist√≥rico...</p>
            <div id="historico-evolucoes-content">
                </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            
            const API_URL = 'https://minhaagenda.onrender.com';
            let listaDePacientesCache = [];
            
            // [NOVO] Vari√°vel para controlar edi√ß√£o
            let pacienteIdEmEdicao = null;

            // --- Seletores (Modal Agendamento) ---
            const modalContainer = document.getElementById('modal-container');
            const modalAgendamentoClose = document.getElementById('modal-agendamento-close');
            let currentAgendamentoId = null; 
            const modalPacienteNome = document.getElementById('modal-paciente-nome');
            const modalPacienteDiagnostico = document.getElementById('modal-paciente-diagnostico');
            const modalPacienteTelefone = document.getElementById('modal-paciente-telefone');
            const modalAgendamentoStatus = document.getElementById('modal-agendamento-status');
            const btnCheckin = document.getElementById('btn-checkin');
            const btnGravar = document.getElementById('btn-gravar');
            const btnSalvarEvolucao = document.getElementById('btn-salvar-evolucao');
            const textoEvolucao = document.getElementById('texto-evolucao');
            const statusGravacao = document.getElementById('status-gravacao');
            const btnCancelar = document.getElementById('btn-cancelar');

            // --- Seletores (Modal Paciente) ---
            const btnAbrirModalPaciente = document.getElementById('btn-abrir-modal-paciente');
            const modalPacienteContainer = document.getElementById('modal-paciente-container');
            const modalPacienteClose = document.getElementById('modal-paciente-close');
            const formNovoPaciente = document.getElementById('form-novo-paciente');
            const modalTituloPaciente = document.getElementById('modal-titulo-paciente'); // [NOVO] Seletor do t√≠tulo

            // --- Seletores (Modal Dashboard) ---
            const btnAbrirDashboard = document.getElementById('btn-abrir-dashboard');
            const modalDashboardContainer = document.getElementById('modal-dashboard-container');
            const modalDashboardClose = document.getElementById('modal-dashboard-close');
            const selectMes = document.getElementById('dash-mes');
            const selectAno = document.getElementById('dash-ano');
            const btnBuscarDashboard = document.getElementById('btn-buscar-dashboard');
            const loadingDashboard = document.getElementById('loading-dashboard');
            const dashboardResultados = document.getElementById('dashboard-resultados');

            // --- Seletores (Modal Lista Pacientes) ---
            const btnAbrirListaPacientes = document.getElementById('btn-abrir-lista-pacientes');
            const modalListaPacientesContainer = document.getElementById('modal-lista-pacientes-container');
            const modalListaPacientesClose = document.getElementById('modal-lista-pacientes-close');
            const listaPacientesTbody = document.getElementById('lista-pacientes-tbody');

            // --- Seletores (Modal Hist√≥rico) ---
            const modalHistoricoContainer = document.getElementById('modal-historico-container');
            const modalHistoricoClose = document.getElementById('modal-historico-close');
            const historicoNomePaciente = document.getElementById('historico-nome-paciente');
            const loadingHistorico = document.getElementById('loading-historico');
            const historicoEvolucoesContent = document.getElementById('historico-evolucoes-content');

            // --- Seletor (Novo Bot√£o de Voz) ---
            const btnCadastroRapidoVoz = document.getElementById('btn-cadastro-rapido-voz');

            // --- L√≥gica da API de Voz para Cadastro R√°pido ---
            const SpeechRecognitionCadastro = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognitionCadastro;

            if (SpeechRecognitionCadastro) {
                recognitionCadastro = new SpeechRecognitionCadastro();
                recognitionCadastro.lang = 'pt-BR';
                recognitionCadastro.continuous = false; 
                recognitionCadastro.interimResults = false;

                btnCadastroRapidoVoz.onclick = () => {
                    try {
                        recognitionCadastro.start();
                        btnCadastroRapidoVoz.textContent = "Ouvindo... üëÇ";
                        btnCadastroRapidoVoz.disabled = true;
                    } catch(e) {
                        console.error("Erro ao iniciar reconhecimento de voz:", e);
                        alert("Erro ao iniciar microfone. Tente novamente.");
                    }
                };

                recognitionCadastro.onend = () => {
                    btnCadastroRapidoVoz.textContent = "Cadastrar por Voz üé§";
                    btnCadastroRapidoVoz.disabled = false;
                };

                recognitionCadastro.onerror = (event) => {
                    console.error("Erro no reconhecimento de voz:", event.error);
                    alert(`Erro na grava√ß√£o: ${event.error}`);
                };

                recognitionCadastro.onresult = (event) => {
                    const transcript = event.results[0][0].transcript.toLowerCase();
                    const triggerPhrase = "cadastrar paciente";

                    if (transcript.startsWith(triggerPhrase)) {
                        let nomePaciente = transcript.substring(triggerPhrase.length).trim();
                        nomePaciente = titleCase(nomePaciente);

                        if (nomePaciente) {
                            console.log(`Iniciando cadastro r√°pido por voz para: ${nomePaciente}`);
                            salvarPacienteRapido(nomePaciente);
                        } else {
                            alert('Comando ouvido, mas o nome estava em branco. Tente "Cadastrar paciente NOME".');
                        }
                    } else {
                        alert(`Comando n√£o reconhecido. Diga, por exemplo: "Cadastrar paciente Jo√£o da Silva".`);
                    }
                };

            } else {
                btnCadastroRapidoVoz.disabled = true;
                btnCadastroRapidoVoz.textContent = "Voz n√£o suportada üòû";
            }

            function titleCase(str) {
                return str.toLowerCase().split(' ').map(word => {
                    return (word.length > 2) ?
                           word.charAt(0).toUpperCase() + word.slice(1) :
                           word;
                }).join(' ');
            }
            
            async function salvarPacienteRapido(nome) {
                const novoPaciente = {
                    nome: nome,
                    telefone: "",
                    data_nascimento: '1900-01-01', // Data padr√£o
                    sexo: 'Outro',               // Sexo padr√£o
                    diagnostico_medico: ""
                };

                try {
                    const response = await fetch(`${API_URL}/pacientes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(novoPaciente)
                    });

                    if (response.ok) {
                        const pacienteCriado = await response.json();
                        alert(`Paciente "${pacienteCriado.nome}" cadastrado com sucesso!`);
                        listaDePacientesCache.push(pacienteCriado); 
                    } else {
                        const error = await response.json();
                        console.error('Erro do backend (voz):', error);
                        alert(`Erro ao cadastrar: ${JSON.stringify(error.detail)}`);
                    }
                } catch (error) {
                    console.error('Erro de rede no cadastro r√°pido:', error);
                    alert('Erro ao conectar com a API.');
                }
            }
            
            // --- L√ìGICA DO CALEND√ÅRIO ---
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek', 
                locale: 'pt-br',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                buttonText: {
                    today: 'Hoje',
                    month: 'M√™s',
                    week: 'Semana',
                    day: 'Dia'
                },
                selectable: true,
                editable: true, 
                select: handleSelectTime,
                eventClick: handleEventClick,
                eventDrop: handleEventDrop, 
                events: `${API_URL}/agendamentos`,
                eventDataTransform: function(apiEvent) {
                    let color = '#3788d8';
                    if (apiEvent.status === 'Presente') color = '#2ca02c';
                    if (apiEvent.status === 'Cancelado') color = '#6c757d';
                    return {
                        id: apiEvent.id,
                        title: `${apiEvent.paciente.nome} (${apiEvent.status})`, 
                        start: apiEvent.data_hora_inicio,
                        end: apiEvent.data_hora_fim,
                        extendedProps: { apiEvent: apiEvent },
                        color: color
                    };
                }
            });

            // --- FUN√á√ïES DE INICIALIZA√á√ÉO ---
            async function carregarPacientes() {
                try {
                    const response = await fetch(`${API_URL}/pacientes`);
                    if (response.ok) {
                        listaDePacientesCache = await response.json();
                        console.log('Cache de pacientes carregado.');
                    } else { console.error('Erro ao carregar pacientes.'); }
                } catch (error) { console.error('Erro de rede ao carregar pacientes:', error); }
            }
            function popularFiltrosDashboard() {
                const hoje = new Date();
                const mesAtual = hoje.getMonth();
                const anoAtual = hoje.getFullYear();
                const nomesMeses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                nomesMeses.forEach((nome, index) => {
                    selectMes.add(new Option(nome, index + 1));
                });
                selectMes.value = mesAtual + 1;
                for (let i = 0; i < 5; i++) {
                    selectAno.add(new Option(anoAtual - i, anoAtual - i));
                }
                selectAno.value = anoAtual;
            }
            
            carregarPacientes().then(() => {
                calendar.render();
                popularFiltrosDashboard();
            });

            // --- FUN√á√ïES DO CALEND√ÅRIO ---
            
            async function handleSelectTime(selectionInfo) {
                // ESTA FUN√á√ÉO SER√Å O ALVO DA NOSSA PR√ìXIMA MELHORIA (IDEIA 1)
                let nomePaciente = prompt('Digite o NOME do paciente para agendar:');
                if (!nomePaciente) return;
                const pacienteEncontrado = listaDePacientesCache.find(
                    p => p.nome.toLowerCase() === nomePaciente.trim().toLowerCase()
                );
                if (!pacienteEncontrado) {
                    alert('Paciente n√£o encontrado. Verifique o nome ou cadastre-o primeiro.');
                    return;
                }
                const novoAgendamento = {
                    paciente_id: pacienteEncontrado.id,
                    data_hora_inicio: selectionInfo.start.toISOString(),
                    data_hora_fim: selectionInfo.end.toISOString()
                };
                try {
                    const response = await fetch(`${API_URL}/agendamentos`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(novoAgendamento)
                    });
                    if (response.ok) {
                        alert('Agendamento criado com sucesso!');
                        calendar.refetchEvents();
                    } else {
                        const error = await response.json();
                        alert(`Erro ao agendar: ${JSON.stringify(error.detail)}`);
                    }
                } catch (error) { console.error('Erro de rede:', error); }
            }

            function handleEventClick(clickInfo) {
                const apiEvent = clickInfo.event.extendedProps.apiEvent;
                currentAgendamentoId = apiEvent.id; 
                modalPacienteNome.textContent = apiEvent.paciente.nome;
                modalPacienteDiagnostico.textContent = apiEvent.paciente.diagnostico_medico || 'Nenhum';
                modalPacienteTelefone.textContent = apiEvent.paciente.telefone;
                modalAgendamentoStatus.textContent = apiEvent.status;
                textoEvolucao.value = '';
                statusGravacao.textContent = '';
                
                if (apiEvent.status === 'Agendado') {
                    btnCheckin.style.display = 'inline-block';
                    btnCancelar.style.display = 'inline-block';
                } else {
                    btnCheckin.style.display = 'none';
                    btnCancelar.style.display = 'none';
                }
                modalContainer.style.display = 'flex';
            }

            async function handleEventDrop(dropInfo) {
                const event = dropInfo.event;
                const agendamentoId = event.id;
                if (!confirm(`Mover o atendimento de "${event.title}" para ${event.start.toLocaleString('pt-BR')}?`)) {
                    dropInfo.revert();
                    return;
                }
                const updateData = {
                    data_hora_inicio: event.start.toISOString(),
                    data_hora_fim: event.end ? event.end.toISOString() : event.start.toISOString()
                };
                try {
                    const response = await fetch(`${API_URL}/agendamentos/${agendamentoId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updateData)
                    });
                    if (response.ok) {
                        alert('Agendamento atualizado com sucesso!');
                        calendar.refetchEvents();
                    } else {
                        alert('Erro ao atualizar o agendamento.');
                        dropInfo.revert();
                    }
                } catch (error) {
                    console.error('Erro de rede ao atualizar:', error);
                    alert('Erro de conex√£o. A altera√ß√£o ser√° desfeita.');
                    dropInfo.revert();
                }
            }

            // --- L√ìGICA DO MODAL DE AGENDAMENTO ---
            modalAgendamentoClose.onclick = () => modalContainer.style.display = 'none';
            btnCheckin.onclick = async () => {
                try {
                    const response = await fetch(`${API_URL}/agendamentos/${currentAgendamentoId}/checkin`, { method: 'POST' });
                    if (response.ok) {
                        alert('Check-in realizado!');
                        modalContainer.style.display = 'none';
                        calendar.refetchEvents();
                    } else {
                        const error = await response.json();
                        alert(`Erro no check-in: ${JSON.stringify(error.detail)}`);
                    }
                } catch (error) { console.error('Erro de rede:', error); }
            };
            btnCancelar.onclick = async () => {
                if (!confirm("Tem certeza que deseja CANCELAR este atendimento?")) { return; }
                try {
                    const response = await fetch(`${API_URL}/agendamentos/${currentAgendamentoId}/cancelar`, { method: 'POST' });
                    if (response.ok) {
                        alert('Agendamento cancelado com sucesso!');
                        modalContainer.style.display = 'none';
                        calendar.refetchEvents();
                    } else {
                        const error = await response.json();
                        alert(`Erro ao cancelar: ${JSON.stringify(error.detail)}`);
                    }
                } catch (error) { console.error('Erro de rede:', error); }
            };
            btnSalvarEvolucao.onclick = async () => {
                const texto = textoEvolucao.value;
                if (!texto) { alert('O campo de evolu√ß√£o est√° vazio.'); return; }
                try {
                    const response = await fetch(`${API_URL}/agendamentos/${currentAgendamentoId}/evolucoes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ texto_evolucao: texto })
                    });
                    if (response.ok) {
                        alert('Evolu√ß√£o salva com sucesso!');
                        modalContainer.style.display = 'none';
                    } else {
                        const error = await response.json();
                        alert(`Erro ao salvar evolu√ß√£o: ${JSON.stringify(error.detail)}`);
                    }
                } catch (error) { console.error('Erro de rede:', error); }
            };

            // --- L√ìGICA DA API DE VOZ (EVOLU√á√ÉO) ---
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'pt-BR';
                recognition.interimResults = true;
                recognition.continuous = true;
                let finalTranscript = '';
                recognition.onstart = () => {
                    finalTranscript = textoEvolucao.value;
                    statusGravacao.textContent = 'Ouvindo... Fale agora.';
                    btnGravar.textContent = 'Parar ‚èπÔ∏è';
                    btnGravar.style.backgroundColor = '#6c757d';
                };
                recognition.onend = () => {
                    statusGravacao.textContent = 'Grava√ß√£o parada.';
                    btnGravar.textContent = 'Gravar üé§';
                    btnGravar.style.backgroundColor = '#dc3545';
                };
                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += (finalTranscript.length > 0 ? ' ' : '') + transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    textoEvolucao.value = finalTranscript + (interimTranscript ? ' (' + interimTranscript + ')' : '');
                };
                recognition.onerror = (event) => { statusGravacao.textContent = 'Erro na grava√ß√£o: ' + event.error; };
            } else {
                statusGravacao.textContent = 'Seu navegador n√£o suporta a API de Voz.';
                btnGravar.disabled = true;
            }
            btnGravar.onclick = () => {
                if (btnGravar.textContent.includes('Gravar')) {
                    recognition.start();
                } else {
                    recognition.stop();
                }
            };
            
            // --- L√ìGICA DO MODAL DE CADASTRO DE PACIENTE (CRIAR E EDITAR) ---
            btnAbrirModalPaciente.onclick = () => {
                formNovoPaciente.reset();
                pacienteIdEmEdicao = null; // [MODIFICADO] Garante que √© modo CRIA√á√ÉO
                modalTituloPaciente.textContent = 'Cadastrar Novo Paciente'; // Reseta o t√≠tulo
                modalPacienteContainer.style.display = 'flex';
            };
            modalPacienteClose.onclick = () => {
                modalPacienteContainer.style.display = 'none';
                pacienteIdEmEdicao = null; // Limpa o ID em edi√ß√£o ao fechar
            }
            
            // [FUN√á√ÉO MODIFICADA] para lidar com CRIAR (POST) e ATUALIZAR (PATCH)
            formNovoPaciente.onsubmit = async (event) => {
                event.preventDefault(); 
                
                let dataNasc = document.getElementById('paciente-nasc').value;
                let sexo = document.getElementById('paciente-sexo').value;

                // Monta o objeto com os dados do formul√°rio
                const dadosPaciente = {
                    nome: document.getElementById('paciente-nome').value,
                    telefone: document.getElementById('paciente-telefone').value,
                    data_nascimento: dataNasc ? dataNasc : '1900-01-01', 
                    sexo: sexo ? sexo : 'Outro', 
                    diagnostico_medico: document.getElementById('paciente-diag').value
                };

                // Valida√ß√£o do nome
                if (!dadosPaciente.nome) {
                    alert('O campo Nome Completo √© obrigat√≥rio.');
                    return;
                }

                // Define o m√©todo e a URL com base no modo (Cria√ß√£o vs Edi√ß√£o)
                let method = 'POST';
                let url = `${API_URL}/pacientes`;
                
                if (pacienteIdEmEdicao) {
                    method = 'PATCH'; // Usamos PATCH para atualiza√ß√£o parcial
                    url = `${API_URL}/pacientes/${pacienteIdEmEdicao}`;
                }
                
                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dadosPaciente)
                    });

                    if (response.ok) {
                        const pacienteAtualizado = await response.json();
                        
                        if (pacienteIdEmEdicao) {
                            // MODO EDI√á√ÉO: Atualiza o paciente no cache
                            alert(`Paciente "${pacienteAtualizado.nome}" atualizado com sucesso!`);
                            // Encontra o √≠ndice do paciente antigo e o substitui
                            const index = listaDePacientesCache.findIndex(p => p.id === pacienteIdEmEdicao);
                            if (index !== -1) {
                                listaDePacientesCache[index] = pacienteAtualizado;
                            }
                        } else {
                            // MODO CRIA√á√ÉO: Adiciona o novo paciente ao cache
                            alert(`Paciente "${pacienteAtualizado.nome}" cadastrado com sucesso! \nNovo ID: ${pacienteAtualizado.id}`);
                            listaDePacientesCache.push(pacienteAtualizado);
                        }
                        
                        formNovoPaciente.reset();
                        modalPacienteContainer.style.display = 'none';
                        pacienteIdEmEdicao = null; // Limpa o ID
                        
                        // Fecha o modal de lista para for√ßar a reabertura com dados novos
                        modalListaPacientesContainer.style.display = 'none'; 
                    } else {
                        const error = await response.json();
                        console.error('Erro do backend (form):', error);
                        alert(`Erro ao salvar: ${JSON.stringify(error.detail)}`);
                    }
                } catch (error) {
                    console.error('Erro de rede:', error);
                    alert('Erro ao conectar com a API.');
                }
            };

            // --- L√ìGICA DO MODAL DASHBOARD ---
            btnAbrirDashboard.onclick = () => {
                dashboardResultados.innerHTML = "";
                modalDashboardContainer.style.display = 'flex';
            };
            modalDashboardClose.onclick = () => modalDashboardContainer.style.display = 'none';
            btnBuscarDashboard.onclick = async () => {
                const ano = selectAno.value;
                const mes = selectMes.value;
                loadingDashboard.style.display = 'block';
                dashboardResultados.innerHTML = "";
                try {
                    const response = await fetch(`${API_URL}/dashboard/sessoes-por-mes?ano=${ano}&mes=${mes}`);
                    if (!response.ok) { throw new Error('Erro ao buscar dados.'); }
                    const dados = await response.json();
                    let tabelaHTML = '<table class="modal-table"><tr><th>Paciente</th><th>Total de Sess√µes</th></tr>';
                    if (dados.length === 0) {
                        tabelaHTML = "<p>Nenhuma sess√£o realizada encontrada para este per√≠odo.</p>";
                    } else {
                        dados.forEach(item => {
                            tabelaHTML += `<tr><td>${item.nome_paciente}</td><td>${item.total_sessoes}</td></tr>`;
                        });
                        tabelaHTML += "</table>";
                    }
                    dashboardResultados.innerHTML = tabelaHTML;
                } catch (error) {
                    console.error('Erro no dashboard:', error);
                    dashboardResultados.innerHTML = "<p style='color: red;'>Erro ao carregar dados.</p>";
                } finally {
                    loadingDashboard.style.display = 'none';
                }
            };

            // --- L√ìGICA DO MODAL LISTA PACIENTES (COM BOT√ïES DE A√á√ÉO) ---
            btnAbrirListaPacientes.onclick = () => {
                listaPacientesTbody.innerHTML = ""; 
                listaDePacientesCache.sort((a, b) => a.nome.localeCompare(b.nome));

                if (listaDePacientesCache.length === 0) {
                    listaPacientesTbody.innerHTML = "<tr><td colspan='4'>Nenhum paciente cadastrado.</td></tr>";
                } else {
                    listaDePacientesCache.forEach(paciente => {
                        const tr = document.createElement('tr');
                        
                        // C√©lula do Hist√≥rico (clique na linha)
                        const tdId = document.createElement('td');
                        tdId.textContent = paciente.id;
                        const tdNome = document.createElement('td');
                        tdNome.textContent = paciente.nome;
                        const tdTel = document.createElement('td');
                        tdTel.textContent = paciente.telefone || 'N/A';
                        
                        [tdId, tdNome, tdTel].forEach(td => {
                            td.onclick = () => abrirHistoricoPaciente(paciente.id, paciente.nome);
                            td.style.cursor = 'pointer'; // Mant√©m o cursor
                        });

                        // [NOVO] C√©lula de A√ß√µes (com bot√µes)
                        const tdAcoes = document.createElement('td');
                        
                        const btnEditar = document.createElement('button');
                        btnEditar.textContent = '‚úèÔ∏è';
                        btnEditar.className = 'btn-acao btn-acao-edit';
                        btnEditar.onclick = (e) => {
                            e.stopPropagation(); // Impede que o clique abra o hist√≥rico
                            handleEditarPaciente(paciente);
                        };

                        const btnExcluir = document.createElement('button');
                        btnExcluir.textContent = 'üóëÔ∏è';
                        btnExcluir.className = 'btn-acao btn-acao-delete';
                        btnExcluir.onclick = (e) => {
                            e.stopPropagation(); // Impede que o clique abra o hist√≥rico
                            handleExcluirPaciente(paciente.id, paciente.nome);
                        };

                        tdAcoes.appendChild(btnEditar);
                        tdAcoes.appendChild(btnExcluir);
                        
                        tr.appendChild(tdId);
                        tr.appendChild(tdNome);
                        tr.appendChild(tdTel);
                        tr.appendChild(tdAcoes); // Adiciona a nova c√©lula
                        
                        listaPacientesTbody.appendChild(tr);
                    });
                }
                modalListaPacientesContainer.style.display = 'flex';
            };
            modalListaPacientesClose.onclick = () => modalListaPacientesContainer.style.display = 'none';

            // --- [NOVAS] FUN√á√ïES DE A√á√ÉO (EDITAR E EXCLUIR) ---

            function handleEditarPaciente(paciente) {
                // 1. Fecha o modal da lista
                modalListaPacientesContainer.style.display = 'none';
                
                // 2. Define o ID de edi√ß√£o (para o onsubmit saber)
                pacienteIdEmEdicao = paciente.id;
                
                // 3. Preenche o formul√°rio com os dados do paciente
                modalTituloPaciente.textContent = `Editando Paciente: ${paciente.nome}`;
                document.getElementById('paciente-nome').value = paciente.nome;
                document.getElementById('paciente-telefone').value = paciente.telefone || '';
                
                // Corrige o formato da data (API envia YYYY-MM-DD)
                if (paciente.data_nascimento && paciente.data_nascimento.includes('T')) {
                     document.getElementById('paciente-nasc').value = paciente.data_nascimento.split('T')[0];
                } else if (paciente.data_nascimento) {
                    document.getElementById('paciente-nasc').value = paciente.data_nascimento;
                } else {
                    document.getElementById('paciente-nasc').value = '';
                }

                document.getElementById('paciente-sexo').value = paciente.sexo || '';
                document.getElementById('paciente-diag').value = paciente.diagnostico_medico || '';
                
                // 4. Abre o modal de cadastro (agora em modo de edi√ß√£o)
                modalPacienteContainer.style.display = 'flex';
            }

            async function handleExcluirPaciente(pacienteId, pacienteNome) {
                if (!confirm(`Tem certeza que deseja excluir "${pacienteNome}"?\n\nATEN√á√ÉO: Isso √© permanente e n√£o pode ser desfeito.`)) {
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/pacientes/${pacienteId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        alert(`Paciente "${pacienteNome}" exclu√≠do com sucesso.`);
                        // Remove o paciente do cache local
                        listaDePacientesCache = listaDePacientesCache.filter(p => p.id !== pacienteId);
                        // Fecha o modal da lista (para recarregar na pr√≥xima vez)
                        modalListaPacientesContainer.style.display = 'none';
                    } else {
                        const error = await response.json();
                        console.error('Erro ao excluir:', error);
                        alert(`Erro ao excluir paciente: ${JSON.stringify(error.detail)}\n\n(Lembre-se: voc√™ n√£o pode excluir um paciente que tenha agendamentos. Cancele-os primeiro ou ajuste a API).`);
                    }
                } catch (error) {
                    console.error('Erro de rede ao excluir:', error);
                    alert('Erro de conex√£o ao tentar excluir.');
                }
            }


            // --- L√ìGICA DO MODAL HIST√ìRICO DE EVOLU√á√ïES ---
            modalHistoricoClose.onclick = () => modalHistoricoContainer.style.display = 'none';
            async function abrirHistoricoPaciente(pacienteId, pacienteNome) {
                historicoNomePaciente.textContent = pacienteNome;
                loadingHistorico.style.display = 'block';
                historicoEvolucoesContent.innerHTML = "";
                modalHistoricoContainer.style.display = 'flex';
                
                try {
                    const response = await fetch(`${API_URL}/pacientes/${pacienteId}/evolucoes`);
                    if (!response.ok) {
                        throw new Error('Erro ao buscar hist√≥rico.');
                    }
                    const evolucoes = await response.json();
                    
                    if (evolucoes.length === 0) {
                        historicoEvolucoesContent.innerHTML = "<p>Nenhuma evolu√ß√£o registrada para este paciente.</p>";
                    } else {
                        evolucoes.sort((a, b) => new Date(b.data_criacao) - new Date(a.data_criacao));

                        evolucoes.forEach(evo => {
                            const data = new Date(evo.data_criacao).toLocaleString('pt-BR');
                            const itemHTML = `
                                <div class="evolucao-item">
                                    <div class="evolucao-data">${data}</div>
                                    <div class="evolucao-texto">${evo.texto_evolucao}</div>
                                </div>
                            `;
                            historicoEvolucoesContent.innerHTML += itemHTML;
                        });
                    }
                } catch (error) {
                    console.error('Erro ao buscar hist√≥rico:', error);
                    historicoEvolucoesContent.innerHTML = "<p style='color: red;'>Erro ao carregar hist√≥rico.</p>";
                } finally {
                    loadingHistorico.style.display = 'none';
                }
            }

            // (Fechar Modais ao clicar fora)
            window.onclick = (event) => {
                if (event.target == modalContainer) modalContainer.style.display = 'none';
                if (event.target == modalPacienteContainer) {
                    modalPacienteContainer.style.display = 'none';
                    pacienteIdEmEdicao = null; // Limpa o ID em edi√ß√£o
                }
                if (event.target == modalDashboardContainer) modalDashboardContainer.style.display = 'none';
                if (event.target == modalListaPacientesContainer) modalListaPacientesContainer.style.display = 'none';
                if (event.target == modalHistoricoContainer) modalHistoricoContainer.style.display = 'none';
            };
        });
    </script>

</body>
</html>