<!DOCTYPE html>
<html lang='pt-br'>
<head>
    <meta charset='utf-8' />
    <title>Agenda de Fisioterapia</title>
    
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding: 20px;
        }
        #calendar {
            max-width: 1100px;
            margin: 0 auto;
        }
        .fc-event {
            cursor: pointer;
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1100px;
            margin: 0 auto;
            margin-bottom: 20px;
        }
        .header-controls button {
            font-size: 0.9em;
            padding: 10px 15px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            color: white;
            font-weight: bold;
            margin-left: 10px;
        }
        #btn-abrir-modal-paciente {
            background-color: #17a2b8;
        }
        #btn-abrir-dashboard {
            background-color: #6f42c1;
        }
        #btn-abrir-lista-pacientes {
            background-color: #28a745;
        }

        .modal-container {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            border-radius: 8px;
            padding: 25px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-content h3, .modal-content h4 {
            margin-top: 0;
        }
        .modal-content textarea {
            width: 95%;
            height: 150px;
            font-size: 1.1em;
            margin-top: 10px;
        }
        .modal-content button {
            font-size: 1em;
            padding: 10px 15px;
            margin-top: 15px;
            margin-right: 10px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
        }
        
        #btn-checkin { background-color: #28a745; color: white; }
        #btn-cancelar { background-color: #ffc107; color: black; } 
        #btn-gravar { background-color: #dc3545; color: white; }
        #btn-salvar-evolucao { background-color: #007bff; color: white; }
        #status-gravacao { font-style: italic; color: #555; }

        .modal-content form { 
            display: flex; 
            flex-direction: column; 
        }
        .modal-content form label { 
            margin-top: 15px; 
            font-weight: bold; 
            font-size: 0.9em;
        }
        .modal-content form input,
        .modal-content form select,
        .modal-content form textarea#paciente-diag {
            width: 95%;
            padding: 8px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-top: 5px;
            height: auto;
        }
        #btn-salvar-paciente { 
            background-color: #007bff; 
            color: white; 
            margin-top: 20px;
        }

        .modal-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .modal-table th, .modal-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .modal-table th {
            background-color: #f2f2f2;
        }
        
        #lista-pacientes-tbody tr {
            cursor: pointer; /* Faz as linhas da lista de pacientes clic√°veis */
        }
        #lista-pacientes-tbody tr:hover {
            background-color: #f5f5f5;
        }
        
        /* Estilos do Hist√≥rico de Evolu√ß√£o */
        #historico-evolucoes-content .evolucao-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
            margin-bottom: 10px;
        }
        #historico-evolucoes-content .evolucao-item:last-child {
            border-bottom: none;
        }
        #historico-evolucoes-content .evolucao-data {
            font-weight: bold;
            font-size: 0.9em;
            color: #555;
        }
        #historico-evolucoes-content .evolucao-texto {
            font-size: 1em;
            margin-top: 5px;
            white-space: pre-wrap; /* Preserva quebras de linha */
        }
        #loading-dashboard, #loading-historico {
            display: none;
            font-style: italic;
        }

        #dashboard-filtros {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }
        #dashboard-filtros select, #dashboard-filtros button {
            padding: 8px;
            font-size: 1em;
            margin-top: 0;
        }
    </style>
</head>
<body>

    <div class="header-controls">
        <h2>Minha Agenda de Fisioterapia</h2>
        <div>
            <button id="btn-abrir-lista-pacientes">Ver Pacientes üìã</button>
            <button id="btn-abrir-dashboard">Dashboard üìä</button>
            <button id="btn-abrir-modal-paciente">Cadastrar Novo Paciente +</button>
        </div>
    </div>

    <div id='calendar'></div>

    <div id="modal-container" class="modal-container">
        <div class="modal-content">
            <span class="modal-close" id="modal-agendamento-close">&times;</span>
            <h3 id="modal-paciente-nome">Nome do Paciente</h3>
            <p><strong>Diagn√≥stico:</strong> <span id="modal-paciente-diagnostico"></span></p>
            <p><strong>Telefone:</strong> <span id="modal-paciente-telefone"></span></p>
            <p><strong>Status:</strong> <span id="modal-agendamento-status"></span></p>
            <button id="btn-checkin">Fazer Check-in</button>
            <button id="btn-cancelar">Cancelar Atendimento</button>
            <hr style="margin-top: 20px;">
            <h4>Evolu√ß√£o da Sess√£o</h4>
            <textarea id="texto-evolucao" placeholder="Digite ou grave a evolu√ß√£o..."></textarea>
            <p id="status-gravacao"></p>
            <button id="btn-gravar">Gravar üé§</button>
            <button id="btn-salvar-evolucao">Salvar Evolu√ß√£o</button>
        </div>
    </div>
    
    <div id="modal-paciente-container" class="modal-container">
        <div class="modal-content">
            <span class="modal-close" id="modal-paciente-close">&times;</span>
            <h3>Cadastrar Novo Paciente</h3>
            <form id="form-novo-paciente">
                <label for="paciente-nome">Nome Completo:</label>
                <input type="text" id="paciente-nome" required>
                <label for="paciente-telefone">Telefone:</label>
                <input type="text" id="paciente-telefone" placeholder="(XX) 9XXXX-XXXX">
                <label for="paciente-nasc">Data de Nascimento:</label>
                <input type="date" id="paciente-nasc" required>
                <label for="paciente-sexo">Sexo:</label>
                <select id="paciente-sexo" required>
                    <option value="Feminino">Feminino</option>
                    <option value="Masculino">Masculino</option>
                    <option value="Outro">Outro</option>
                </select>
                <label for="paciente-diag">Diagn√≥stico M√©dico:</label>
                <textarea id="paciente-diag" rows="3"></textarea>
                <button type="submit" id="btn-salvar-paciente">Salvar Paciente</button>
            </form>
        </div>
    </div>

    <div id="modal-dashboard-container" class="modal-container">
        <div class="modal-content">
            <span class="modal-close" id="modal-dashboard-close">&times;</span>
            <h3>Dashboard de Sess√µes Realizadas</h3>
            <div id="dashboard-filtros">
                <label for="dash-mes">M√™s:</label>
                <select id="dash-mes"></select>
                <label for="dash-ano">Ano:</label>
                <select id="dash-ano"></select>
                <button id="btn-buscar-dashboard">Buscar</button>
            </div>
            <p id="loading-dashboard">Carregando dados...</p>
            <div id="dashboard-resultados">
                <table class="modal-table">
                    </table>
            </div>
        </div>
    </div>
    
    <div id="modal-lista-pacientes-container" class="modal-container">
        <div class="modal-content">
            <span class="modal-close" id="modal-lista-pacientes-close">&times;</span>
            <h3>Pacientes Cadastrados</h3>
            <p style="font-size: 0.9em; color: #555;">Clique em um paciente para ver seu hist√≥rico de evolu√ß√µes.</p>
            <div id="lista-pacientes-resultados">
                <table class="modal-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Telefone</th>
                        </tr>
                    </thead>
                    <tbody id="lista-pacientes-tbody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="modal-historico-container" class="modal-container">
        <div class="modal-content">
            <span class="modal-close" id="modal-historico-close">&times;</span>
            <h3>Hist√≥rico de <span id="historico-nome-paciente"></span></h3>
            <p id="loading-historico">Carregando hist√≥rico...</p>
            <div id="historico-evolucoes-content">
                </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            
            const API_URL = 'https://minhaagenda.onrender.com';
            let listaDePacientesCache = [];
            
            // --- Seletores (Modal Agendamento) ---
            const modalContainer = document.getElementById('modal-container');
            const modalAgendamentoClose = document.getElementById('modal-agendamento-close');
            let currentAgendamentoId = null; 
            const modalPacienteNome = document.getElementById('modal-paciente-nome');
            const modalPacienteDiagnostico = document.getElementById('modal-paciente-diagnostico');
            const modalPacienteTelefone = document.getElementById('modal-paciente-telefone');
            const modalAgendamentoStatus = document.getElementById('modal-agendamento-status');
            const btnCheckin = document.getElementById('btn-checkin');
            const btnGravar = document.getElementById('btn-gravar');
            const btnSalvarEvolucao = document.getElementById('btn-salvar-evolucao');
            const textoEvolucao = document.getElementById('texto-evolucao');
            const statusGravacao = document.getElementById('status-gravacao');
            const btnCancelar = document.getElementById('btn-cancelar');

            // --- Seletores (Modal Paciente) ---
            const btnAbrirModalPaciente = document.getElementById('btn-abrir-modal-paciente');
            const modalPacienteContainer = document.getElementById('modal-paciente-container');
            const modalPacienteClose = document.getElementById('modal-paciente-close');
            const formNovoPaciente = document.getElementById('form-novo-paciente');

            // --- Seletores (Modal Dashboard) ---
            const btnAbrirDashboard = document.getElementById('btn-abrir-dashboard');
            const modalDashboardContainer = document.getElementById('modal-dashboard-container');
            const modalDashboardClose = document.getElementById('modal-dashboard-close');
            const selectMes = document.getElementById('dash-mes');
            const selectAno = document.getElementById('dash-ano');
            const btnBuscarDashboard = document.getElementById('btn-buscar-dashboard');
            const loadingDashboard = document.getElementById('loading-dashboard');
            const dashboardResultados = document.getElementById('dashboard-resultados');

            // --- Seletores (Modal Lista Pacientes) ---
            const btnAbrirListaPacientes = document.getElementById('btn-abrir-lista-pacientes');
            const modalListaPacientesContainer = document.getElementById('modal-lista-pacientes-container');
            const modalListaPacientesClose = document.getElementById('modal-lista-pacientes-close');
            const listaPacientesTbody = document.getElementById('lista-pacientes-tbody');

            // --- Seletores (Modal Hist√≥rico) ---
            const modalHistoricoContainer = document.getElementById('modal-historico-container');
            const modalHistoricoClose = document.getElementById('modal-historico-close');
            const historicoNomePaciente = document.getElementById('historico-nome-paciente');
            const loadingHistorico = document.getElementById('loading-historico');
            const historicoEvolucoesContent = document.getElementById('historico-evolucoes-content');


            // --- L√ìGICA DO CALEND√ÅRIO ---
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek', 
                locale: 'pt-br',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                buttonText: {
                    today: 'Hoje',
                    month: 'M√™s',
                    week: 'Semana',
                    day: 'Dia'
                },
                selectable: true,
                select: handleSelectTime,
                eventClick: handleEventClick,
                events: `${API_URL}/agendamentos`,
                eventDataTransform: function(apiEvent) {
                    let color = '#3788d8';
                    if (apiEvent.status === 'Presente') color = '#2ca02c';
                    if (apiEvent.status === 'Cancelado') color = '#6c757d';
                    return {
                        id: apiEvent.id,
                        title: `${apiEvent.paciente.nome} (${apiEvent.status})`, 
                        start: apiEvent.data_hora_inicio,
                        end: apiEvent.data_hora_fim,
                        extendedProps: { apiEvent: apiEvent },
                        color: color
                    };
                }
            });

            // --- FUN√á√ïES DE INICIALIZA√á√ÉO ---
            async function carregarPacientes() {
                try {
                    const response = await fetch(`${API_URL}/pacientes`);
                    if (response.ok) {
                        listaDePacientesCache = await response.json();
                        console.log('Cache de pacientes carregado.');
                    } else { console.error('Erro ao carregar pacientes.'); }
                } catch (error) { console.error('Erro de rede ao carregar pacientes:', error); }
            }
            function popularFiltrosDashboard() {
                const hoje = new Date();
                const mesAtual = hoje.getMonth();
                const anoAtual = hoje.getFullYear();
                const nomesMeses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                nomesMeses.forEach((nome, index) => {
                    selectMes.add(new Option(nome, index + 1));
                });
                selectMes.value = mesAtual + 1;
                for (let i = 0; i < 5; i++) {
                    selectAno.add(new Option(anoAtual - i, anoAtual - i));
                }
                selectAno.value = anoAtual;
            }
            
            carregarPacientes().then(() => {
                calendar.render();
                popularFiltrosDashboard();
            });

            // --- FUN√á√ïES DO CALEND√ÅRIO ---
            
            async function handleSelectTime(selectionInfo) {
                let nomePaciente = prompt('Digite o NOME do paciente para agendar:');
                if (!nomePaciente) return;
                const pacienteEncontrado = listaDePacientesCache.find(
                    p => p.nome.toLowerCase() === nomePaciente.trim().toLowerCase()
                );
                if (!pacienteEncontrado) {
                    alert('Paciente n√£o encontrado. Verifique o nome ou cadastre-o primeiro.');
                    return;
                }
                const novoAgendamento = {
                    paciente_id: pacienteEncontrado.id,
                    data_hora_inicio: selectionInfo.start.toISOString(),
                    data_hora_fim: selectionInfo.end.toISOString()
                };
                try {
                    const response = await fetch(`${API_URL}/agendamentos`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(novoAgendamento)
                    });
                    if (response.ok) {
                        alert('Agendamento criado com sucesso!');
                        calendar.refetchEvents();
                    } else {
                        const error = await response.json();
                        alert(`Erro ao agendar: ${error.detail}`);
                    }
                } catch (error) { console.error('Erro de rede:', error); }
            }

            function handleEventClick(clickInfo) {
                const apiEvent = clickInfo.event.extendedProps.apiEvent;
                currentAgendamentoId = apiEvent.id; 
                modalPacienteNome.textContent = apiEvent.paciente.nome;
                modalPacienteDiagnostico.textContent = apiEvent.paciente.diagnostico_medico || 'Nenhum';
                modalPacienteTelefone.textContent = apiEvent.paciente.telefone;
                modalAgendamentoStatus.textContent = apiEvent.status;
                textoEvolucao.value = '';
                statusGravacao.textContent = '';
                
                if (apiEvent.status === 'Agendado') {
                    btnCheckin.style.display = 'inline-block';
                    btnCancelar.style.display = 'inline-block';
                } else {
                    btnCheckin.style.display = 'none';
                    btnCancelar.style.display = 'none';
                }
                modalContainer.style.display = 'flex';
            }

            // --- L√ìGICA DO MODAL DE AGENDAMENTO ---
            modalAgendamentoClose.onclick = () => modalContainer.style.display = 'none';
            btnCheckin.onclick = async () => {
                try {
                    const response = await fetch(`${API_URL}/agendamentos/${currentAgendamentoId}/checkin`, { method: 'POST' });
                    if (response.ok) {
                        alert('Check-in realizado!');
                        modalContainer.style.display = 'none';
                        calendar.refetchEvents();
                    } else {
                        const error = await response.json();
                        alert(`Erro no check-in: ${error.detail}`);
                    }
                } catch (error) { console.error('Erro de rede:', error); }
            };
            
            btnCancelar.onclick = async () => {
                if (!confirm("Tem certeza que deseja CANCELAR este atendimento?")) { return; }
                try {
                    const response = await fetch(`${API_URL}/agendamentos/${currentAgendamentoId}/cancelar`, { method: 'POST' });
                    if (response.ok) {
                        alert('Agendamento cancelado com sucesso!');
                        modalContainer.style.display = 'none';
                        calendar.refetchEvents();
                    } else {
                        const error = await response.json();
                        alert(`Erro ao cancelar: ${error.detail}`);
                    }
                } catch (error) { console.error('Erro de rede:', error); }
            };
            
            btnSalvarEvolucao.onclick = async () => {
                const texto = textoEvolucao.value;
                if (!texto) { alert('O campo de evolu√ß√£o est√° vazio.'); return; }
                try {
                    const response = await fetch(`${API_URL}/agendamentos/${currentAgendamentoId}/evolucoes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ texto_evolucao: texto })
                    });
                    if (response.ok) {
                        alert('Evolu√ß√£o salva com sucesso!');
                        modalContainer.style.display = 'none';
                    } else {
                        const error = await response.json();
                        alert(`Erro ao salvar evolu√ß√£o: ${error.detail}`);
                    }
                } catch (error) { console.error('Erro de rede:', error); }
            };

            // --- L√ìGICA DA API DE VOZ ---
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'pt-BR';
                recognition.interimResults = true;
                recognition.continuous = true;
                let finalTranscript = '';
                recognition.onstart = () => {
                    finalTranscript = textoEvolucao.value;
                    statusGravacao.textContent = 'Ouvindo... Fale agora.';
                    btnGravar.textContent = 'Parar ‚èπÔ∏è';
                    btnGravar.style.backgroundColor = '#6c757d';
                };
                recognition.onend = () => {
                    statusGravacao.textContent = 'Grava√ß√£o parada.';
                    btnGravar.textContent = 'Gravar üé§';
                    btnGravar.style.backgroundColor = '#dc3545';
                };
                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += (finalTranscript.length > 0 ? ' ' : '') + transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    textoEvolucao.value = finalTranscript + (interimTranscript ? ' (' + interimTranscript + ')' : '');
                };
                recognition.onerror = (event) => { statusGravacao.textContent = 'Erro na grava√ß√£o: ' + event.error; };
            } else {
                statusGravacao.textContent = 'Seu navegador n√£o suporta a API de Voz.';
                btnGravar.disabled = true;
            }
            btnGravar.onclick = () => {
                if (btnGravar.textContent.includes('Gravar')) {
                    recognition.start();
                } else {
                    recognition.stop();
                }
            };
            
            // --- L√ìGICA DO MODAL DE CADASTRO DE PACIENTE ---
            btnAbrirModalPaciente.onclick = () => {
                formNovoPaciente.reset();
                modalPacienteContainer.style.display = 'flex';
            };
            modalPacienteClose.onclick = () => modalPacienteContainer.style.display = 'none';
            formNovoPaciente.onsubmit = async (event) => {
                event.preventDefault(); 
                const novoPaciente = {
                    nome: document.getElementById('paciente-nome').value,
                    telefone: document.getElementById('paciente-telefone').value,
                    data_nascimento: document.getElementById('paciente-nasc').value,
                    sexo: document.getElementById('paciente-sexo').value,
                    diagnostico_medico: document.getElementById('paciente-diag').value
                };
                if (!novoPaciente.nome || !novoPaciente.data_nascimento) {
                    alert('Nome e Data de Nascimento s√£o obrigat√≥rios.');
                    return;
                }
                try {
                    const response = await fetch(`${API_URL}/pacientes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(novoPaciente)
                    });
                    if (response.ok) {
                        const pacienteCriado = await response.json();
                        alert(`Paciente "${pacienteCriado.nome}" cadastrado com sucesso! \nNovo ID: ${pacienteCriado.id}`);
                        formNovoPaciente.reset();
                        modalPacienteContainer.style.display = 'none';
                        listaDePacientesCache.push(pacienteCriado);
                    } else {
                        const error = await response.json();
                        alert(`Erro ao cadastrar: ${error.detail}`);
                    }
                } catch (error) {
                    console.error('Erro de rede:', error);
                    alert('Erro ao conectar com a API.');
                }
            };

            // --- L√ìGICA DO MODAL DASHBOARD ---
            btnAbrirDashboard.onclick = () => {
                dashboardResultados.innerHTML = "";
                modalDashboardContainer.style.display = 'flex';
            };
            modalDashboardClose.onclick = () => modalDashboardContainer.style.display = 'none';
            btnBuscarDashboard.onclick = async () => {
                const ano = selectAno.value;
                const mes = selectMes.value;
                loadingDashboard.style.display = 'block';
                dashboardResultados.innerHTML = "";
                try {
                    const response = await fetch(`${API_URL}/dashboard/sessoes-por-mes?ano=${ano}&mes=${mes}`);
                    if (!response.ok) { throw new Error('Erro ao buscar dados.'); }
                    const dados = await response.json();
                    let tabelaHTML = '<table class="modal-table"><tr><th>Paciente</th><th>Total de Sess√µes</th></tr>';
                    if (dados.length === 0) {
                        tabelaHTML = "<p>Nenhuma sess√£o realizada encontrada para este per√≠odo.</p>";
                    } else {
                        dados.forEach(item => {
                            tabelaHTML += `<tr><td>${item.nome_paciente}</td><td>${item.total_sessoes}</td></tr>`;
                        });
                        tabelaHTML += "</table>";
                    }
                    dashboardResultados.innerHTML = tabelaHTML;
                } catch (error) {
                    console.error('Erro no dashboard:', error);
                    dashboardResultados.innerHTML = "<p style='color: red;'>Erro ao carregar dados.</p>";
                } finally {
                    loadingDashboard.style.display = 'none';
                }
            };

            // --- L√ìGICA DO MODAL LISTA PACIENTES ---
            btnAbrirListaPacientes.onclick = () => {
                listaPacientesTbody.innerHTML = ""; 
                if (listaDePacientesCache.length === 0) {
                    listaPacientesTbody.innerHTML = "<tr><td colspan='3'>Nenhum paciente cadastrado.</td></tr>";
                } else {
                    listaDePacientesCache.forEach(paciente => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${paciente.id}</td>
                            <td>${paciente.nome}</td>
                            <td>${paciente.telefone}</td>
                        `;
                        // Adiciona o evento de clique para abrir o hist√≥rico
                        tr.onclick = () => {
                            abrirHistoricoPaciente(paciente.id, paciente.nome);
                        };
                        listaPacientesTbody.appendChild(tr);
                    });
                }
                modalListaPacientesContainer.style.display = 'flex';
            };
            modalListaPacientesClose.onclick = () => modalListaPacientesContainer.style.display = 'none';

            // --- NOVO: L√ìGICA DO MODAL HIST√ìRICO DE EVOLU√á√ïES ---
            modalHistoricoClose.onclick = () => modalHistoricoContainer.style.display = 'none';

            async function abrirHistoricoPaciente(pacienteId, pacienteNome) {
                // Prepara o modal
                historicoNomePaciente.textContent = pacienteNome;
                loadingHistorico.style.display = 'block';
                historicoEvolucoesContent.innerHTML = "";
                modalHistoricoContainer.style.display = 'flex';
                
                // Busca os dados na API
                try {
                    const response = await fetch(`${API_URL}/pacientes/${pacienteId}/evolucoes`);
                    if (!response.ok) {
                        throw new Error('Erro ao buscar hist√≥rico.');
                    }
                    const evolucoes = await response.json();
                    
                    if (evolucoes.length === 0) {
                        historicoEvolucoesContent.innerHTML = "<p>Nenhuma evolu√ß√£o registrada para este paciente.</p>";
                    } else {
                        // Formata e exibe cada evolu√ß√£o
                        evolucoes.forEach(evo => {
                            const data = new Date(evo.data_criacao).toLocaleString('pt-BR');
                            const itemHTML = `
                                <div class="evolucao-item">
                                    <div class="evolucao-data">${data}</div>
                                    <div class="evolucao-texto">${evo.texto_evolucao}</div>
                                </div>
                            `;
                            historicoEvolucoesContent.innerHTML += itemHTML;
                        });
                    }
                    
                } catch (error) {
                    console.error('Erro ao buscar hist√≥rico:', error);
                    historicoEvolucoesContent.innerHTML = "<p style='color: red;'>Erro ao carregar hist√≥rico.</p>";
                } finally {
                    loadingHistorico.style.display = 'none'; // Esconde "Carregando..."
                }
            }
            // --- FIM NOVO ---


            // (Fechar Modais ao clicar fora)
            window.onclick = (event) => {
                if (event.target == modalContainer) modalContainer.style.display = 'none';
                if (event.target == modalPacienteContainer) modalPacienteContainer.style.display = 'none';
                if (event.target == modalDashboardContainer) modalDashboardContainer.style.display = 'none';
                if (event.target == modalListaPacientesContainer) modalListaPacientesContainer.style.display = 'none';
                if (event.target == modalHistoricoContainer) modalHistoricoContainer.style.display = 'none'; // NOVO
            };
        });
    </script>

</body>
</html>