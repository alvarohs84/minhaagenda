<!DOCTYPE html>
<html lang='pt-br'>
<head>
    <meta charset='utf-8' />
    <title>FisioManager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
    
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <style>
        :root {
            --sidebar-bg: #2c3e50;
            --main-bg: #ecf0f1;
            --sidebar-text: #ecf0f1;
            --sidebar-text-hover: #ffffff;
            --sidebar-active-bg: #3498db;
            --header-border: #bdc3c7;
            --color-verde: #198754;
            --color-roxo: #6f42c1;
            --color-azul-claro: #0dcaf0;
            --color-laranja: #fd7e14;
            --color-amarelo: #ffc107;
            --color-azul: #0d6efd;
            --color-vermelho: #dc3545;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex; 
            height: 100vh;
            overflow: hidden; 
        }

        /* --- Estilos do Menu Lateral (Sidebar) --- */
        .sidebar {
            width: 240px;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        .sidebar-logo {
            text-align: center;
            padding: 10px 0;
            margin-bottom: 15px;
        }
        .sidebar-logo img {
            width: 180px; 
            max-width: 90%;
        }
        .sidebar nav {
            display: flex;
            flex-direction: column;
            margin-top: 0; 
            flex-grow: 1;
        }
        .sidebar nav a {
            color: var(--sidebar-text);
            text-decoration: none;
            padding: 12px 15px;
            border-radius: 5px;
            margin-bottom: 8px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .sidebar nav a:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--sidebar-text-hover);
        }
        .sidebar nav a.active {
            background-color: var(--sidebar-active-bg);
            color: white;
        }
        .sidebar-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px; 
        }
        .sidebar-buttons button {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            text-align: center;
        }
        
        /* --- Estilos da √Årea Principal --- */
        .main-content {
            flex-grow: 1; 
            background-color: var(--main-bg);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .main-header {
            padding: 15px 25px;
            background-color: white;
            border-bottom: 1px solid var(--header-border);
            display: flex;
            justify-content: flex-end; 
            gap: 10px;
        }
        .main-header button {
            font-size: 0.9em;
            padding: 10px 15px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            color: white;
            font-weight: bold;
            margin-left: 0;
        }
        
        main {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto; 
            height: calc(100vh - 70px); 
        }

        .view-section {
            display: none; 
        }

        /* --- Estilos do Calend√°rio (Ajustados) --- */
        #calendar-container {
            max-width: 1100px;
            margin: 0 auto;
        }
        .fc-event {
            cursor: pointer;
        }
        .fc-timegrid-axis-header .fc-scrollgrid-shrink-cushion {
            font-weight: bold;
            text-align: center;
        }

        /* --- Estilos dos Bot√µes de A√ß√£o (Cores) --- */
        #btn-abrir-agendamento-manual { background-color: var(--color-azul); }
        #btn-agendar-por-voz { background-color: var(--color-amarelo); color: black; }
        #btn-abrir-lista-pacientes { background-color: var(--color-verde); }
        #btn-abrir-dashboard { background-color: var(--color-roxo); }
        #btn-abrir-modal-paciente { background-color: var(--color-azul-claro); color: black; }
        #btn-cadastro-rapido-voz { background-color: var(--color-laranja); }


        /* --- Estilos dos Modais --- */
        .modal-container {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            border-radius: 8px;
            padding: 25px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-content h3, .modal-content h4 {
            margin-top: 0;
        }
        .modal-content textarea {
            width: 95%;
            height: 150px;
            font-size: 1.1em;
            margin-top: 10px;
        }
        .modal-content button {
            font-size: 1em;
            padding: 10px 15px;
            margin-top: 15px;
            margin-right: 10px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
        }
        
        #btn-checkin { background-color: #28a745; color: white; }
        #btn-cancelar { background-color: #ffc107; color: black; } 
        #btn-excluir-agendamento { background-color: #dc3545; color: white; }
        #btn-gravar { background-color: #dc3545; color: white; }
        #btn-salvar-evolucao { background-color: #007bff; color: white; }
        #status-gravacao { font-style: italic; color: #555; }

        .modal-content form { 
            display: flex; 
            flex-direction: column; 
        }
        .modal-content form label { 
            margin-top: 15px; 
            font-weight: bold; 
            font-size: 0.9em;
        }
        .checkbox-label {
            display: flex;
            flex-direction: row;
            align-items: center;
            font-weight: normal;
            font-size: 1em;
            margin-top: 10px;
        }
        .checkbox-label input {
            width: auto;
            margin-right: 10px;
        }

        .dias-semana-container {
            display: flex;
            flex-wrap: wrap; 
            gap: 5px 15px; 
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            margin-top: 5px;
        }
        .dias-semana-container .checkbox-label {
            font-weight: normal;
            font-size: 0.9em;
            margin-top: 0; 
        }


        .modal-content form input,
        .modal-content form select,
        .modal-content form textarea#paciente-diag,
        .modal-content form textarea#paciente-avaliacao { 
            width: 95%;
            padding: 8px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-top: 5px;
            height: auto;
        }
        #btn-salvar-paciente { 
            background-color: #007bff; 
            color: white; 
            margin-top: 20px;
        }

        #btn-salvar-agendamento,
        #btn-salvar-agendamento-manual {
            background-color: #28a745;
            color: white;
            margin-top: 20px;
        }

        .modal-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .modal-table th, .modal-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .modal-table th {
            background-color: #f2f2f2;
        }
        
        #lista-pacientes-tbody tr {
            cursor: pointer;
        }
        #lista-pacientes-tbody tr:hover {
            background-color: #f5f5f5;
        }
        
        .btn-acao {
            padding: 5px 8px;
            font-size: 0.9em;
            margin-right: 5px;
        }
        .btn-acao-edit {
            background-color: var(--color-amarelo); 
            color: black;
        }
        .btn-acao-delete {
            background-color: var(--color-vermelho); 
            color: white;
        }
        .btn-acao-prontuario {
            background-color: var(--color-azul);
            color: white;
        }
        
        #historico-evolucoes-content .evolucao-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
            margin-bottom: 10px;
        }
        #historico-evolucoes-content .evolucao-item:last-child {
            border-bottom: none;
        }
        #historico-evolucoes-content .evolucao-data {
            font-weight: bold;
            font-size: 0.9em;
            color: #555;
        }
        #historico-evolucoes-content .evolucao-texto {
            font-size: 1em;
            margin-top: 5px;
            white-space: pre-wrap;
        }
        #loading-dashboard, #loading-historico {
            display: none;
            font-style: italic;
        }

        #dashboard-filtros {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }
        #dashboard-filtros select, #dashboard-filtros button {
            padding: 8px;
            font-size: 1em;
            margin-top: 0;
        }

        #view-pacientes, #view-dashboard {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .toastify {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            font-size: 1em;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }
        .toastify.toast-success {
            background: linear-gradient(to right, #00b09b, #96c93d);
        }
        .toastify.toast-error {
            background: linear-gradient(to right, #ff5f6d, #ffc371);
        }


        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            #app-container {
                flex-direction: column; 
            }
            .sidebar {
                width: 100%; 
                height: auto;
                padding: 15px;
                flex-direction: row; 
                justify-content: space-between;
                align-items: center;
                box-sizing: border-box; 
            }
            .sidebar-logo img {
                width: 150px; 
                height: auto;
            }
            .sidebar nav {
                display: none; 
            }
            .sidebar-buttons {
                display: none; 
            }
            #btn-logout {
                display: none; 
            }

            .main-content {
                height: calc(100vh - 75px); 
            }
            .main-header {
                padding: 10px;
                justify-content: center; 
                flex-wrap: wrap; 
                gap: 10px;
            }
            .main-header button {
                flex-grow: 1; 
                min-width: calc(50% - 10px); 
                margin-left: 0;
            }
            
            main {
                padding: 10px;
            }

            .modal-content {
                width: 95%;
                margin: 10px auto; 
                padding: 20px 15px;
                max-height: 90vh; 
            }
            #lista-pacientes-resultados {
                overflow-x: auto;
            }
            #dashboard-filtros {
                flex-direction: column;
                align-items: stretch; 
            }
        }
    </style>
</head>
<body>

    <div id="app-container" style="display: flex;">
        <div class="sidebar">
            <div class="sidebar-logo">
                <img src="FisioManager.png" alt="FisioManager Logo">
            </div>
            <nav>
                <a href="#" id="nav-agenda" class="active">üìÖ Agenda</a>
                <a href="#" id="nav-pacientes">üìã Pacientes</a>
                <a href="#" id="nav-dashboard">üìä Dashboard</a>
            </nav>
            <div class="sidebar-buttons">
                <button id="btn-abrir-modal-paciente">Cadastrar Novo Paciente +</button>
                <button id="btn-abrir-agendamento-manual">Agendar Paciente üìÖ</button>
            </div>
            </div>

        <div class="main-content">
            
            <header class="main-header">
                <button id="btn-abrir-modal-paciente-header">Cadastrar Novo Paciente +</button>
                <button id="btn-abrir-agendamento-manual-header">Agendar Paciente üìÖ</button>
                <button id="btn-agendar-por-voz">Agendar por Voz üó£Ô∏è</button>
                <button id="btn-cadastro-rapido-voz">Cadastrar por Voz üé§</button>
            </header>
            
            <main>
                <div id="view-agenda" class="view-section" style="display: block;">
                    <div id='calendar-container'>
                        <div id='calendar'></div>
                    </div>
                </div>

                <div id="view-pacientes" class="view-section">
                    <h3>Pacientes Cadastrados</h3>
                    <p style="font-size: 0.9em; color: #555;">Clique no √≠cone üìÑ para ver o prontu√°rio (avalia√ß√£o e evolu√ß√µes).</p>
                    <div id="lista-pacientes-resultados">
                        <table class="modal-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nome</th>
                                    <th>Telefone</th>
                                    <th>A√ß√µes</th> 
                                </tr>
                            </thead>
                            <tbody id="lista-pacientes-tbody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="view-dashboard" class="view-section">
                    <h3>Dashboard de Sess√µes Realizadas</h3>
                    <div id="dashboard-filtros">
                        <label for="dash-mes">M√™s:</label>
                        <select id="dash-mes"></select>
                        <label for="dash-ano">Ano:</label>
                        <select id="dash-ano"></select>
                        <button id="btn-buscar-dashboard">Buscar</button>
                    </div>
                    <p id="loading-dashboard">Carregando dados...</p>
                    <div id="dashboard-resultados">
                        <table class="modal-table">
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>


    <div id="modal-container" class="modal-container">
        <div class="modal-content">
            <span class="modal-close" id="modal-agendamento-close">&times;</span>
            <h3 id="modal-paciente-nome">Nome do Paciente</h3>
            <p><strong>Diagn√≥stico:</strong> <span id="modal-paciente-diagnostico"></span></p>
            <p><strong>Telefone:</strong> <span id="modal-paciente-telefone"></span></p>
            <p><strong>Status:</strong> <span id="modal-agendamento-status"></span></p>
            
            <button id="btn-checkin">Fazer Check-in</button>
            <button id="btn-cancelar">Cancelar Atendimento</button>
            <button id="btn-excluir-agendamento">Excluir Agendamento üóëÔ∏è</button>

            <hr style="margin-top: 20px;">
            <h4>Evolu√ß√£o da Sess√£o</h4>
            <textarea id="texto-evolucao" placeholder="Digite ou grave a evolu√ß√£o..."></textarea>
            <p id="status-gravacao"></p>
            <button id="btn-gravar">Gravar üé§</button>
            <button id="btn-salvar-evolucao">Salvar Evolu√ß√£o</button>
        </div>
    </div>
    
    <div id="modal-paciente-container" class="modal-container">
        <div class="modal-content">
            <span class="modal-close" id="modal-paciente-close">&times;</span>
            <h3 id="modal-titulo-paciente">Cadastrar Novo Paciente</h3> 
            <form id="form-novo-paciente">
                <label for="paciente-nome">Nome Completo:</label>
                <input type="text" id="paciente-nome" required>
                
                <label for="paciente-telefone">Telefone:</label>
                <input type="text" id="paciente-telefone" placeholder="(XX) 9XXXX-XXXX">
                
                <label for="paciente-nasc">Data de Nascimento:</label>
                <input type="date" id="paciente-nasc">
                
                <label for="paciente-sexo">Sexo:</label>
                <select id="paciente-sexo">
                    <option value="">Selecione...</option> 
                    <option value="Feminino">Feminino</option>
                    <option value="Masculino">Masculino</option>
                    <option value="Outro">Outro</option>
                </select>
                
                <label for="paciente-diag">Diagn√≥stico M√©dico:</label>
                <textarea id="paciente-diag" rows="3"></textarea>
                
                <label for="paciente-avaliacao">Avalia√ß√£o Fisioterap√™utica:</label>
                <textarea id="paciente-avaliacao" rows="6" placeholder="Descreva a avalia√ß√£o inicial, objetivos, etc..."></textarea>

                <button type="submit" id="btn-salvar-paciente">Salvar Paciente</button>
            </form>
        </div>
    </div>

    <div id="modal-novo-agendamento" class="modal-container">
        <div class="modal-content">
            <span class="modal-close" id="modal-novo-agendamento-close">&times;</span>
            <h3>Novo Agendamento</h3>
            <p>Selecione o paciente para o hor√°rio:</p>
            <p><strong>Hor√°rio:</strong> <span id="novo-agendamento-horario"></span></p> 
            
            <form id="form-novo-agendamento">
                <label for="input-paciente">Paciente:</label>
                <input type="text" id="input-paciente" list="paciente-list" placeholder="Digite ou selecione um paciente..." required>
                <datalist id="paciente-list">
                    </datalist>

                <label style="margin-top: 20px;">Repetir semanalmente em:</label>
                <div class="dias-semana-container">
                    <label class="checkbox-label"><input type="checkbox" name="dia-semana-clique" value="SU"> Dom</label>
                    <label class="checkbox-label"><input type="checkbox" name="dia-semana-clique" value="MO"> Seg</label>
                    <label class="checkbox-label"><input type="checkbox" name="dia-semana-clique" value="TU"> Ter</label>
                    <label class="checkbox-label"><input type="checkbox" name="dia-semana-clique" value="WE"> Qua</label>
                    <label class="checkbox-label"><input type="checkbox" name="dia-semana-clique" value="TH"> Qui</label>
                    <label class="checkbox-label"><input type="checkbox" name="dia-semana-clique" value="FR"> Sex</label>
                    <label class="checkbox-label"><input type="checkbox" name="dia-semana-clique" value="SA"> S√°b</label>
                </div>
                <small>Deixe todos desmarcados para n√£o repetir.</small>
                
                <button type="submit" id="btn-salvar-agendamento">Agendar</button>
            </form>
        </div>
    </div>

    <div id="modal-agendamento-manual-container" class="modal-container">
        <div class="modal-content">
            <span class="modal-close" id="modal-agendamento-manual-close">&times;</span>
            <h3>Agendar Paciente (Manual)</h3>
            
            <form id="form-agendamento-manual">
                <label for="input-paciente-manual">Paciente:</label>
                <input type="text" id="input-paciente-manual" list="paciente-list-manual" placeholder="Digite ou selecione um paciente..." required>
                <datalist id="paciente-list-manual">
                    </datalist>

                <label for="input-data-manual">Data:</label>
                <input type="date" id="input-data-manual" required>
                
                <label for="input-hora-manual">Hora (In√≠cio):</label>
                <input type="time" id="input-hora-manual" required>

                <label style="margin-top: 20px;">Repetir semanalmente em:</label>
                <div class="dias-semana-container"> 
                    <label class="checkbox-label"><input type="checkbox" name="dia-semana" value="SU"> Dom</label>
                    <label class="checkbox-label"><input type="checkbox" name="dia-semana" value="MO"> Seg</label>
                    <label class="checkbox-label"><input type="checkbox" name="dia-semana" value="TU"> Ter</label>
                    <label class="checkbox-label"><input type="checkbox" name="dia-semana" value="WE"> Qua</label>
                    <label class="checkbox-label"><input type="checkbox" name="dia-semana" value="TH"> Qui</label>
                    <label class="checkbox-label"><input type="checkbox" name="dia-semana" value="FR"> Sex</label>
                    <label class="checkbox-label"><input type="checkbox" name="dia-semana" value="SA"> S√°b</label>
                </div>
                <small>Deixe todos desmarcados para n√£o repetir.</small>


                <button type="submit" id="btn-salvar-agendamento-manual">Agendar</button>
            </form>
        </div>
    </div>
    
    <div id="modal-historico-container" class="modal-container">
        <div class="modal-content">
            <span class="modal-close" id="modal-historico-close">&times;</span>
            <h3>Prontu√°rio de <span id="historico-nome-paciente"></span></h3>
            
            <h4>Avalia√ß√£o Fisioterap√™utica</h4>
            <div id="prontuario-avaliacao" style="white-space: pre-wrap; background: #f9f9f9; border: 1px solid #eee; padding: 10px; border-radius: 4px; min-height: 100px;">
                (Carregando avalia√ß√£o...)
            </div>

            <h4 style="margin-top: 20px;">Evolu√ß√µes Di√°rias</h4>
            <p id="loading-historico">Carregando evolu√ß√µes...</p>
            <div id="historico-evolucoes-content">
                </div>
        </div>
    </div>


    <script>
        // [MODIFICADO] Todo o JavaScript foi revertido para a vers√£o sem login.
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            
            const API_URL = 'https://minhaagenda.onrender.com';
            let listaDePacientesCache = [];
            
            const isMobile = window.innerWidth <= 768;
            let pacienteIdEmEdicao = null;
            let currentSelectionInfo = null; 

            // --- Fun√ß√µes de Notifica√ß√£o (Toast) ---
            function showToast(message, type = 'success') {
                const backgroundColor = type === 'success' ? 
                    "linear-gradient(to right, #00b09b, #96c93d)" : 
                    "linear-gradient(to right, #ff5f6d, #ffc371)";
                
                Toastify({
                    text: message,
                    duration: 3000,
                    close: true,
                    gravity: "top", 
                    position: "right", 
                    stopOnFocus: true, 
                    style: {
                        background: backgroundColor,
                        boxShadow: "0 3px 10px rgba(0, 0, 0, 0.2)",
                        borderRadius: "5px",
                        fontWeight: "bold",
                        fontFamily: "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif"
                    }
                }).showToast();
            }
            function showSuccessToast(message) { showToast(message, 'success'); }
            function showErrorToast(message) { showToast(message, 'error'); }
            
            
            // --- Seletores (Modal Agendamento) ---
            const modalContainer = document.getElementById('modal-container');
            const modalAgendamentoClose = document.getElementById('modal-agendamento-close');
            let currentAgendamentoId = null; 
            const modalPacienteNome = document.getElementById('modal-paciente-nome');
            const modalPacienteDiagnostico = document.getElementById('modal-paciente-diagnostico');
            const modalPacienteTelefone = document.getElementById('modal-paciente-telefone');
            const modalAgendamentoStatus = document.getElementById('modal-agendamento-status');
            const btnCheckin = document.getElementById('btn-checkin');
            const btnGravar = document.getElementById('btn-gravar');
            const btnSalvarEvolucao = document.getElementById('btn-salvar-evolucao');
            const textoEvolucao = document.getElementById('texto-evolucao');
            const statusGravacao = document.getElementById('status-gravacao');
            const btnCancelar = document.getElementById('btn-cancelar');
            const btnExcluirAgendamento = document.getElementById('btn-excluir-agendamento');

            // --- Seletores (Modal Paciente) ---
            const btnAbrirModalPaciente = document.getElementById('btn-abrir-modal-paciente');
            const btnAbrirModalPacienteHeader = document.getElementById('btn-abrir-modal-paciente-header');
            const modalPacienteContainer = document.getElementById('modal-paciente-container');
            const modalPacienteClose = document.getElementById('modal-paciente-close');
            const formNovoPaciente = document.getElementById('form-novo-paciente');
            const modalTituloPaciente = document.getElementById('modal-titulo-paciente'); 

            // --- Seletores (Modal Novo Agendamento) ---
            const modalNovoAgendamento = document.getElementById('modal-novo-agendamento');
            const modalNovoAgendamentoClose = document.getElementById('modal-novo-agendamento-close');
            const formNovoAgendamento = document.getElementById('form-novo-agendamento');
            const inputPaciente = document.getElementById('input-paciente');
            const pacienteDataList = document.getElementById('paciente-list');
            const novoAgendamentoHorario = document.getElementById('novo-agendamento-horario');

            // --- Seletores (Modal Agendamento Manual) ---
            const btnAbrirModalAgendamento = document.getElementById('btn-abrir-agendamento-manual');
            const btnAbrirModalAgendamentoHeader = document.getElementById('btn-abrir-agendamento-manual-header');
            const modalAgendamentoManualContainer = document.getElementById('modal-agendamento-manual-container');
            const modalAgendamentoManualClose = document.getElementById('modal-agendamento-manual-close');
            const formAgendamentoManual = document.getElementById('form-agendamento-manual');
            const inputPacienteManual = document.getElementById('input-paciente-manual');
            const pacienteDataListManual = document.getElementById('paciente-list-manual');
            const inputDataManual = document.getElementById('input-data-manual'); 

            // --- Seletores (Dashboard e Lista Pacientes) ---
            const btnBuscarDashboard = document.getElementById('btn-buscar-dashboard');
            const loadingDashboard = document.getElementById('loading-dashboard');
            const dashboardResultados = document.getElementById('dashboard-resultados');
            const selectMes = document.getElementById('dash-mes');
            const selectAno = document.getElementById('dash-ano');
            const listaPacientesTbody = document.getElementById('lista-pacientes-tbody');

            // --- Seletores (Modal Hist√≥rico) ---
            const modalHistoricoContainer = document.getElementById('modal-historico-container');
            const modalHistoricoClose = document.getElementById('modal-historico-close');
            const historicoNomePaciente = document.getElementById('historico-nome-paciente');
            const loadingHistorico = document.getElementById('loading-historico');
            const historicoEvolucoesContent = document.getElementById('historico-evolucoes-content');
            const prontuarioAvaliacao = document.getElementById('prontuario-avaliacao');

            // --- Seletores de Voz ---
            const btnCadastroRapidoVoz = document.getElementById('btn-cadastro-rapido-voz');
            const btnAgendarPorVoz = document.getElementById('btn-agendar-por-voz'); 
            
            // --- Seletores da Navega√ß√£o ---
            const navAgenda = document.getElementById('nav-agenda');
            const navPacientes = document.getElementById('nav-pacientes');
            const navDashboard = document.getElementById('nav-dashboard');
            const viewAgenda = document.getElementById('view-agenda');
            const viewPacientes = document.getElementById('view-pacientes');
            const viewDashboard = document.getElementById('view-dashboard');
            const allViews = [viewAgenda, viewPacientes, viewDashboard];
            const allNavLinks = [navAgenda, navPacientes, navDashboard];

            // --- L√≥gica da API de Voz para CADASTRO R√ÅPIDO ---
            const SpeechRecognitionCadastro = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognitionCadastro;

            if (SpeechRecognitionCadastro) {
                recognitionCadastro = new SpeechRecognitionCadastro();
                recognitionCadastro.lang = 'pt-BR';
                recognitionCadastro.continuous = false; 
                recognitionCadastro.interimResults = false;

                btnCadastroRapidoVoz.onclick = () => {
                    try {
                        recognitionCadastro.start();
                        btnCadastroRapidoVoz.textContent = "Ouvindo... üëÇ";
                        btnCadastroRapidoVoz.disabled = true;
                    } catch(e) {
                        console.error("Erro ao iniciar reconhecimento de voz:", e);
                        showErrorToast("Erro ao iniciar microfone. Tente novamente.");
                    }
                };

                recognitionCadastro.onend = () => {
                    btnCadastroRapidoVoz.textContent = "Cadastrar por Voz üé§";
                    btnCadastroRapidoVoz.disabled = false;
                };

                recognitionCadastro.onerror = (event) => {
                    console.error("Erro no reconhecimento de voz:", event.error);
                    showErrorToast(`Erro na grava√ß√£o: ${event.error}`);
                };

                recognitionCadastro.onresult = (event) => {
                    const transcript = event.results[0][0].transcript.toLowerCase();
                    const triggerPhrase = "cadastrar paciente";

                    if (transcript.startsWith(triggerPhrase)) {
                        let nomePaciente = transcript.substring(triggerPhrase.length).trim();
                        nomePaciente = titleCase(nomePaciente);

                        if (nomePaciente) {
                            console.log(`Iniciando cadastro r√°pido por voz para: ${nomePaciente}`);
                            salvarPacienteRapido(nomePaciente);
                        } else {
                            showErrorToast('Comando ouvido, mas o nome estava em branco. Tente "Cadastrar paciente NOME".');
                        }
                    } else {
                        showErrorToast(`Comando n√£o reconhecido. Diga, por exemplo: "Cadastrar paciente Jo√£o da Silva".`);
                    }
                };

            } else {
                btnCadastroRapidoVoz.disabled = true;
                btnCadastroRapidoVoz.textContent = "Voz n√£o suportada üòû";
            }

            function titleCase(str) {
                return str.toLowerCase().split(' ').map(word => {
                    return (word.length > 2) ?
                           word.charAt(0).toUpperCase() + word.slice(1) :
                           word;
                }).join(' ');
            }
            
            async function salvarPacienteRapido(nome) {
                const novoPaciente = {
                    nome: nome,
                    telefone: "",
                    data_nascimento: '1900-01-01', 
                    sexo: 'Outro',               
                    diagnostico_medico: ""
                };

                try {
                    const response = await fetch(`${API_URL}/pacientes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(novoPaciente)
                    });

                    if (response.ok) {
                        const pacienteCriado = await response.json();
                        showSuccessToast(`Paciente "${pacienteCriado.nome}" cadastrado com sucesso!`);
                        listaDePacientesCache.push(pacienteCriado); 
                    } else {
                        const error = await response.json();
                        console.error('Erro do backend (voz):', error);
                        showErrorToast(`Erro ao cadastrar: ${JSON.stringify(error.detail)}`);
                    }
                } catch (error) {
                    console.error('Erro de rede no cadastro r√°pido:', error);
                    showErrorToast('Erro ao conectar com a API.');
                }
            }
            
            // --- L√≥gica da API de Voz para AGENDAMENTO ---
            const SpeechRecognitionAgendamento = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognitionAgendamento;

            if (SpeechRecognitionAgendamento) {
                recognitionAgendamento = new SpeechRecognitionAgendamento();
                recognitionAgendamento.lang = 'pt-BR';
                recognitionAgendamento.continuous = false;
                recognitionAgendamento.interimResults = false;

                btnAgendarPorVoz.onclick = () => {
                    try {
                        recognitionAgendamento.start();
                        btnAgendarPorVoz.textContent = "Ouvindo... üëÇ";
                        btnAgendarPorVoz.disabled = true;
                    } catch (e) {
                        showErrorToast("Erro ao iniciar microfone.");
                    }
                };

                recognitionAgendamento.onend = () => {
                    btnAgendarPorVoz.textContent = "Agendar por Voz üó£Ô∏è";
                    btnAgendarPorVoz.disabled = false;
                };

                recognitionAgendamento.onerror = (event) => {
                    showErrorToast(`Erro na grava√ß√£o: ${event.error}`);
                };

                recognitionAgendamento.onresult = async (event) => {
                    const texto = event.results[0][0].transcript.toLowerCase();
                    console.log("Comando ouvido:", texto);
                    if (!texto.startsWith("agendar")) {
                        showErrorToast('Comando n√£o reconhecido. Comece com "Agendar...".');
                        return;
                    }

                    try {
                        const paciente = encontrarPacienteNoTexto(texto);
                        const dataInicio = encontrarDataNoTexto(texto);
                        const [hora, minuto] = encontrarHoraNoTexto(texto);
                        dataInicio.setHours(hora, minuto, 0, 0);
                        const dataFim = new Date(dataInicio.getTime() + 55 * 60000);

                        if (confirm(`Confirmar agendamento?\n\nPaciente: ${paciente.nome}\nHor√°rio: ${dataInicio.toLocaleString('pt-BR')} at√© ${dataFim.toLocaleString('pt-BR')}`)) {
                            await salvarAgendamento(paciente.id, dataInicio, dataFim, null); // Sem repeti√ß√£o por voz
                        }

                    } catch (error) {
                        showErrorToast(`Erro ao processar comando: ${error.message}`);
                    }
                };
            } else {
                btnAgendarPorVoz.disabled = true;
                btnAgendarPorVoz.textContent = "Voz n√£o suportada üòû";
            }
            
            function encontrarPacienteNoTexto(texto) {
                for (const p of listaDePacientesCache) {
                    if (texto.includes(p.nome.toLowerCase())) {
                        return p;
                    }
                }
                throw new Error("Nenhum paciente cadastrado foi encontrado no comando.");
            }

            function encontrarDataNoTexto(texto) {
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);

                if (texto.includes("hoje")) {
                    return new Date();
                }
                if (texto.includes("amanh√£")) {
                    const amanha = new Date(hoje);
                    amanha.setDate(hoje.getDate() + 1);
                    return amanha;
                }
                
                const diasDaSemana = ["domingo", "segunda", "ter√ßa", "quarta", "quinta", "sexta", "s√°bado"];
                for (let i = 0; i < diasDaSemana.length; i++) {
                    if (texto.includes(diasDaSemana[i])) {
                        const diaAlvo = i;
                        const diaAtual = hoje.getDay();
                        let diasDeDiferenca = diaAlvo - diaAtual;
                        if (diasDeDiferenca <= 0) { 
                            diasDeDiferenca += 7;
                        }
                        const proximoDia = new Date(hoje);
                        proximoDia.setDate(hoje.getDate() + diasDeDiferenca);
                        return proximoDia;
                    }
                }
                
                throw new Error("Data n√£o reconhecida (diga 'hoje', 'amanh√£' ou um dia da semana).");
            }

            function encontrarHoraNoTexto(texto) {
                const match = texto.match(/√†s (\d{1,2})( e meia| e trinta)?/);
                if (!match) {
                    throw new Error("Hora n√£o reconhecida (diga '... √†s [hora]' ex: '... √†s 10' ou '... √†s 10 e meia').");
                }
                
                const hora = parseInt(match[1]); 
                const minuto = (match[2] && (match[2].includes("meia") || match[2].includes("trinta"))) ? 30 : 0;
                
                if (hora < 8 || hora > 19) {
                     throw new Error("Hora fora do hor√°rio de atendimento (08:00 - 19:00).");
                }
                return [hora, minuto];
            }

            async function salvarAgendamento(pacienteId, dataInicio, dataFim, rrule = null) {
                const novoAgendamento = {
                    paciente_id: pacienteId, 
                    data_hora_inicio: dataInicio.toISOString(),
                    data_hora_fim: dataFim.toISOString(),
                    rrule: rrule 
                };

                try {
                    const response = await fetch(`${API_URL}/agendamentos`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(novoAgendamento)
                    });
                    if (response.ok) {
                        showSuccessToast('Agendamento criado com sucesso!');
                        calendar.refetchEvents();
                        return true; 
                    } else {
                        const error = await response.json();
                        showErrorToast(`Erro ao agendar: ${JSON.stringify(error.detail)}`);
                        return false; 
                    }
                } catch (error) { 
                    console.error('Erro de rede:', error); 
                    showErrorToast('Erro de conex√£o ao tentar agendar.');
                    return false; 
                }
            }


            // --- L√ìGICA DO CALEND√ÅRIO ---
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: isMobile ? 'timeGridDay' : 'timeGridWeek', 
                locale: 'pt-br',
                
                allDayText: 'Hor√°rio',         
                allDaySlot: true,              
                slotMinTime: '08:00:00',       
                slotMaxTime: '20:00:00',       
                slotDuration: '00:30:00',      
                slotLabelInterval: '01:00:00', 
                slotLabelFormat: {             
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                },

                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: isMobile ? 'timeGridDay,dayGridMonth' : 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                buttonText: {
                    today: 'Hoje',
                    month: 'M√™s',
                    week: 'Semana',
                    day: 'Dia'
                },
                selectable: true,
                editable: true, 
                select: handleSelectTime,
                eventClick: handleEventClick,
                eventDrop: handleEventDrop, 
                
                events: function(fetchInfo, successCallback, failureCallback) {
                    const start = fetchInfo.start.toISOString();
                    const end = fetchInfo.end.toISOString();
                    
                    fetch(`${API_URL}/agendamentos?start=${start}&end=${end}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            const transformedData = data.map(apiEvent => {
                                let color = '#3788d8';
                                if (apiEvent.status === 'Presente') color = '#2ca02c';
                                if (apiEvent.status === 'Cancelado') color = '#6c757d';
                                return {
                                    id: apiEvent.id,
                                    title: `${apiEvent.paciente.nome} (${apiEvent.status})`,
                                    start: apiEvent.data_hora_inicio,
                                    end: apiEvent.data_hora_fim,
                                    extendedProps: { 
                                        apiEvent: apiEvent,
                                        dataOcorrencia: apiEvent.data_hora_inicio 
                                    },
                                    color: color
                                };
                            });
                            successCallback(transformedData);
                        })
                        .catch(error => {
                            console.error('Erro ao buscar agendamentos:', error);
                            failureCallback(error);
                        });
                },
            });

            // --- FUN√á√ïES DE INICIALIZA√á√ÉO ---
            async function carregarPacientes() {
                try {
                    const response = await fetch(`${API_URL}/pacientes`);
                    if (response.ok) {
                        listaDePacientesCache = await response.json();
                        console.log('Cache de pacientes carregado.');
                    } else { 
                        console.error('Erro ao carregar pacientes.'); 
                        showErrorToast("N√£o foi poss√≠vel carregar pacientes. A API pode estar offline.");
                    }
                } catch (error) { 
                    console.error('Erro de rede ao carregar pacientes:', error); 
                    showErrorToast("Erro de conex√£o com a API.");
                }
            }
            function popularFiltrosDashboard() {
                const hoje = new Date();
                const mesAtual = hoje.getMonth();
                const anoAtual = hoje.getFullYear();
                const nomesMeses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                nomesMeses.forEach((nome, index) => {
                    selectMes.add(new Option(nome, index + 1));
                });
                selectMes.value = mesAtual + 1;
                for (let i = 0; i < 5; i++) {
                    selectAno.add(new Option(anoAtual - i, anoAtual - i));
                }
                selectAno.value = anoAtual;
            }
            
            // Inicia o app
            carregarPacientes().then(() => {
                calendar.render();
                popularFiltrosDashboard();
            });
            
            
            // --- L√≥gica de Navega√ß√£o da Sidebar ---
            function showView(viewToShow, linkToActivate) {
                allViews.forEach(view => view.style.display = 'none');
                viewToShow.style.display = 'block';

                allNavLinks.forEach(link => link.classList.remove('active'));
                linkToActivate.classList.add('active');
            }

            navAgenda.onclick = (e) => {
                e.preventDefault();
                showView(viewAgenda, navAgenda);
            };
            
            navPacientes.onclick = (e) => {
                e.preventDefault();
                showView(viewPacientes, navPacientes);
                abrirListaPacientes(); 
            };
            
            navDashboard.onclick = (e) => {
                e.preventDefault();
                showView(viewDashboard, navDashboard);
            };


            // --- FUN√á√ïES DO CALEND√ÅRIO ---
            
            async function handleSelectTime(selectionInfo) {
                const dataInicio = selectionInfo.start;
                const dataFim = new Date(dataInicio.getTime() + 55 * 60000); 
                
                currentSelectionInfo = {
                    start: dataInicio,
                    end: dataFim
                };

                pacienteDataList.innerHTML = ''; 
                listaDePacientesCache.sort((a, b) => a.nome.localeCompare(b.nome)); 
                listaDePacientesCache.forEach(paciente => {
                    const option = document.createElement('option');
                    option.value = paciente.nome; 
                    pacienteDataList.appendChild(option);
                });

                inputPaciente.value = '';

                const inicio = dataInicio.toLocaleString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const fim = dataFim.toLocaleString('pt-BR', { hour: '2-digit', minute: '2-digit' }); 
                const dia = dataInicio.toLocaleString('pt-BR', { dateStyle: 'short' });
                novoAgendamentoHorario.textContent = `${dia} - ${inicio} √†s ${fim}`;
                
                const diasRRule = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA'];
                const diaValor = diasRRule[dataInicio.getDay()];
                
                document.querySelectorAll('input[name="dia-semana-clique"]').forEach(cb => {
                    cb.checked = (cb.value === diaValor); 
                });

                modalNovoAgendamento.style.display = 'flex';
                inputPaciente.focus(); 
            }

            function handleEventClick(clickInfo) {
                const apiEvent = clickInfo.event.extendedProps.apiEvent;
                currentAgendamentoId = apiEvent.id; 
                
                currentSelectionInfo = { 
                    start: new Date(clickInfo.event.start),
                    isRecorrente: !!apiEvent.rrule
                };

                modalPacienteNome.textContent = apiEvent.paciente.nome;
                modalPacienteDiagnostico.textContent = apiEvent.paciente.diagnostico_medico || 'Nenhum';
                modalPacienteTelefone.textContent = apiEvent.paciente.telefone;
                modalAgendamentoStatus.textContent = apiEvent.status;
                textoEvolucao.value = '';
                statusGravacao.textContent = '';
                
                btnExcluirAgendamento.style.display = 'inline-block';
                if (apiEvent.status === 'Agendado') {
                    btnCheckin.style.display = 'inline-block';
                    btnCancelar.style.display = 'inline-block';
                } else {
                    btnCheckin.style.display = 'none';
                    btnCancelar.style.display = 'none';
                }
                modalContainer.style.display = 'flex';
            }

            async function handleEventDrop(dropInfo) {
                const event = dropInfo.event;
                const oldEvent = dropInfo.oldEvent;
                const agendamentoId = event.id;
                const apiEvent = event.extendedProps.apiEvent;
                
                let dataFim;
                if (event.end) {
                    dataFim = event.end; 
                } else {
                    const duracao = oldEvent.end.getTime() - oldEvent.start.getTime(); 
                    dataFim = new Date(event.start.getTime() + duracao);
                }
                
                if (!apiEvent.rrule) {
                    if (!confirm(`Mover o atendimento de "${event.title}" para ${event.start.toLocaleString('pt-BR')}?`)) {
                        dropInfo.revert();
                        return;
                    }
                    
                    const updateData = {
                        data_hora_inicio: event.start.toISOString(),
                        data_hora_fim: dataFim.toISOString()
                    };
                    
                    try {
                        const response = await fetch(`${API_URL}/agendamentos/${agendamentoId}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(updateData)
                        });
                        if (response.ok) {
                            showSuccessToast('Agendamento atualizado com sucesso!');
                            calendar.refetchEvents(); 
                        } else {
                            showErrorToast('Erro ao atualizar o agendamento.');
                            dropInfo.revert();
                        }
                    } catch (error) {
                        console.error('Erro de rede ao atualizar:', error);
                        showErrorToast('Erro de conex√£o. A altera√ß√£o ser√° desfeita.');
                        dropInfo.revert();
                    }
                } else {
                    if (!confirm(`Mover o atendimento de "${event.title}" para ${event.start.toLocaleString('pt-BR')}?\n\nClique em 'OK' para mover S√ì ESTA ocorr√™ncia.\nClique em 'Cancelar' para n√£o fazer nada.`)) {
                        dropInfo.revert();
                        return;
                    }
                    
                    const updateData = {
                        data_original: oldEvent.start.toISOString(),
                        novo_inicio: event.start.toISOString(),
                        novo_fim: dataFim.toISOString()
                    };

                    try {
                        const response = await fetch(`${API_URL}/agendamentos/${agendamentoId}/mover_ocorrencia`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(updateData)
                        });
                        if (response.ok) {
                            showSuccessToast('Ocorr√™ncia movida com sucesso!');
                            calendar.refetchEvents(); 
                        } else {
                            showErrorToast('Erro ao mover a ocorr√™ncia.');
                            dropInfo.revert();
                        }
                    } catch (error) {
                        console.error('Erro de rede ao mover:', error);
                        showErrorToast('Erro de conex√£o. A altera√ß√£o ser√° desfeita.');
                        dropInfo.revert();
                    }
                }
            }

            // --- L√ìGICA DO MODAL DE AGENDAMENTO (EVOLU√á√ÉO) ---
            modalAgendamentoClose.onclick = () => modalContainer.style.display = 'none';
            btnCheckin.onclick = async () => {
                let url = `${API_URL}/agendamentos/${currentAgendamentoId}/checkin`;
                let body = null;

                if (currentSelectionInfo.isRecorrente) {
                    url = `${API_URL}/agendamentos/${currentAgendamentoId}/status_ocorrencia`;
                    body = JSON.stringify({
                        data_ocorrencia: currentSelectionInfo.start.toISOString(),
                        novo_status: 'Presente'
                    });
                }
                
                try {
                    const response = await fetch(url, { 
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: body
                    });
                    if (response.ok) {
                        showSuccessToast('Check-in realizado!');
                        modalContainer.style.display = 'none';
                        calendar.refetchEvents();
                    } else {
                        const error = await response.json();
                        showErrorToast(`Erro no check-in: ${JSON.stringify(error.detail)}`);
                    }
                } catch (error) { console.error('Erro de rede:', error); }
            };
            btnCancelar.onclick = async () => {
                if (!confirm("Tem certeza que deseja CANCELAR este atendimento?")) { return; }
                
                let url = `${API_URL}/agendamentos/${currentAgendamentoId}/cancelar`;
                let body = null;

                if (currentSelectionInfo.isRecorrente) {
                    url = `${API_URL}/agendamentos/${currentAgendamentoId}/status_ocorrencia`;
                    body = JSON.stringify({
                        data_ocorrencia: currentSelectionInfo.start.toISOString(),
                        novo_status: 'Cancelado'
                    });
                }
                
                try {
                    const response = await fetch(url, { 
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: body
                    });
                    if (response.ok) {
                        showSuccessToast('Agendamento cancelado com sucesso!');
                        modalContainer.style.display = 'none';
                        calendar.refetchEvents();
                    } else {
                        const error = await response.json();
                        showErrorToast(`Erro ao cancelar: ${JSON.stringify(error.detail)}`);
                    }
                } catch (error) { console.error('Erro de rede:', error); }
            };
            
            btnSalvarEvolucao.onclick = async () => {
                const texto = textoEvolucao.value;
                if (!texto) { showErrorToast('O campo de evolu√ß√£o est√° vazio.'); return; }
                
                let idRealParaSalvar = currentAgendamentoId;
                
                try {
                    const response = await fetch(`${API_URL}/agendamentos/${idRealParaSalvar}/evolucoes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ texto_evolucao: texto })
                    });
                    if (response.ok) {
                        showSuccessToast('Evolu√ß√£o salva com sucesso!');
                        modalContainer.style.display = 'none';
                    } else {
                        const error = await response.json();
                        showErrorToast(`Erro ao salvar evolu√ß√£o: ${error.detail}`);
                    }
                } catch (error) { console.error('Erro de rede:', error); }
            };

            btnExcluirAgendamento.onclick = async () => {
                if (!confirm(`Tem certeza que deseja EXCLUIR PERMANENTEMENTE este agendamento?\n\nPaciente: ${modalPacienteNome.textContent}\nIsso n√£o pode ser desfeito.`)) {
                    return;
                }
                
                try {
                    const response = await fetch(`${API_URL}/agendamentos/${currentAgendamentoId}`, { 
                        method: 'DELETE' 
                    });
                    
                    if (response.ok) {
                        showSuccessToast('Agendamento exclu√≠do com sucesso!');
                        modalContainer.style.display = 'none';
                        calendar.refetchEvents();
                    } else {
                        const error = await response.json();
                        showErrorToast(`Erro ao excluir agendamento: ${JSON.stringify(error.detail)}`);
                    }
                } catch (error) { 
                    console.error('Erro de rede ao excluir agendamento:', error); 
                    showErrorToast('Erro de conex√£o ao tentar excluir o agendamento.');
                }
            };

            // --- L√ìGICA DA API DE VOZ (EVOLU√á√ÉO) ---
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'pt-BR';
                recognition.interimResults = true;
                recognition.continuous = true;
                let finalTranscript = '';
                recognition.onstart = () => {
                    finalTranscript = textoEvolucao.value;
                    statusGravacao.textContent = 'Ouvindo... Fale agora.';
                    btnGravar.textContent = 'Parar ‚èπÔ∏è';
                    btnGravar.style.backgroundColor = '#6c757d';
                };
                recognition.onend = () => {
                    statusGravacao.textContent = 'Grava√ß√£o parada.';
                    btnGravar.textContent = 'Gravar üé§';
                    btnGravar.style.backgroundColor = '#dc3545';
                };
                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += (finalTranscript.length > 0 ? ' ' : '') + transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    textoEvolucao.value = finalTranscript + (interimTranscript ? ' (' + interimTranscript + ')' : '');
                };
                recognition.onerror = (event) => { statusGravacao.textContent = 'Erro na grava√ß√£o: ' + event.error; };
            } else {
                statusGravacao.textContent = 'Seu navegador n√£o suporta a API de Voz.';
                btnGravar.disabled = true;
            }
            btnGravar.onclick = () => {
                if (btnGravar.textContent.includes('Gravar')) {
                    recognition.start();
                } else {
                    recognition.stop();
                }
            };
            
            // --- L√ìGICA DO MODAL DE CADASTRO DE PACIENTE (CRIAR E EDITAR) ---
            const showCadastroModal = () => {
                formNovoPaciente.reset();
                pacienteIdEmEdicao = null; 
                modalTituloPaciente.textContent = 'Cadastrar Novo Paciente'; 
                modalPacienteContainer.style.display = 'flex';
            };
            btnAbrirModalPaciente.onclick = showCadastroModal;
            btnAbrirModalPacienteHeader.onclick = showCadastroModal;
            
            modalPacienteClose.onclick = () => {
                modalPacienteContainer.style.display = 'none';
                pacienteIdEmEdicao = null; 
            }
            
            formNovoPaciente.onsubmit = async (event) => {
                event.preventDefault(); 
                
                let dataNasc = document.getElementById('paciente-nasc').value;
                let sexo = document.getElementById('paciente-sexo').value;

                const dadosPaciente = {
                    nome: document.getElementById('paciente-nome').value,
                    telefone: document.getElementById('paciente-telefone').value,
                    data_nascimento: dataNasc ? dataNasc : '1900-01-01', 
                    sexo: sexo ? sexo : 'Outro', 
                    diagnostico_medico: document.getElementById('paciente-diag').value,
                    avaliacao: document.getElementById('paciente-avaliacao').value 
                };

                if (!dadosPaciente.nome) {
                    showErrorToast('O campo Nome Completo √© obrigat√≥rio.');
                    return;
                }

                let method = 'POST';
                let url = `${API_URL}/pacientes`;
                
                if (pacienteIdEmEdicao) {
                    method = 'PATCH'; 
                    url = `${API_URL}/pacientes/${pacienteIdEmEdicao}`;
                }
                
                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dadosPaciente)
                    });

                    if (response.ok) {
                        const pacienteAtualizado = await response.json();
                        
                        if (pacienteIdEmEdicao) {
                            showSuccessToast(`Paciente "${pacienteAtualizado.nome}" atualizado com sucesso!`);
                            const index = listaDePacientesCache.findIndex(p => p.id === pacienteIdEmEdicao);
                            if (index !== -1) {
                                listaDePacientesCache[index] = pacienteAtualizado;
                            }
                        } else {
                            showSuccessToast(`Paciente "${pacienteAtualizado.nome}" cadastrado com sucesso!`);
                            listaDePacientesCache.push(pacienteAtualizado);
                        }
                        
                        formNovoPaciente.reset();
                        modalPacienteContainer.style.display = 'none';
                        pacienteIdEmEdicao = null; 
                        
                        abrirListaPacientes(); // Atualiza a tabela
                    } else {
                        const error = await response.json();
                        console.error('Erro do backend (form):', error);
                        showErrorToast(`Erro ao salvar: ${JSON.stringify(error.detail)}`);
                    }
                } catch (error) {
                    console.error('Erro de rede:', error);
                    showErrorToast('Erro ao conectar com a API.');
                }
            };

            // --- L√≥gica do Modal de NOVO AGENDAMENTO (clique na agenda) ---
            modalNovoAgendamentoClose.onclick = () => {
                modalNovoAgendamento.style.display = 'none';
                currentSelectionInfo = null; 
            }
            
            formNovoAgendamento.onsubmit = async (event) => {
                event.preventDefault();
                
                const nomePaciente = inputPaciente.value;
                
                if (!nomePaciente) {
                    showErrorToast('Por favor, digite o nome do paciente.');
                    return;
                }

                const pacienteEncontrado = listaDePacientesCache.find(
                    p => p.nome.toLowerCase() === nomePaciente.toLowerCase().trim()
                );

                if (!pacienteEncontrado) {
                    showErrorToast('Paciente n√£o encontrado. Por favor, selecione um nome v√°lido da lista ou cadastre o paciente primeiro.');
                    return;
                }
                
                const pacienteId = pacienteEncontrado.id; 
                
                if (!currentSelectionInfo) {
                    showErrorToast('Erro: Nenhuma informa√ß√£o de hor√°rio encontrada. Tente clicar novamente.');
                    return;
                }
                
                const diasSelecionados = [];
                document.querySelectorAll('input[name="dia-semana-clique"]:checked').forEach(cb => {
                    diasSelecionados.push(cb.value);
                });

                const diasRRule = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA'];
                const diaDaSemanaInicio = diasRRule[currentSelectionInfo.start.getDay()];
                if (diasSelecionados.length > 0 && !diasSelecionados.includes(diaDaSemanaInicio)) {
                    diasSelecionados.push(diaDaSemanaInicio);
                }

                let rruleStr = null;
                if (diasSelecionados.length > 0) {
                    rruleStr = `FREQ=WEEKLY;BYDAY=${diasSelecionados.join(',')}`;
                }

                const sucesso = await salvarAgendamento(pacienteId, currentSelectionInfo.start, currentSelectionInfo.end, rruleStr);
                
                if (sucesso) {
                    modalNovoAgendamento.style.display = 'none'; 
                    currentSelectionInfo = null; 
                }
            }

            // --- L√≥gica do Modal de AGENDAMENTO MANUAL (bot√£o) ---
            const showAgendamentoManualModal = () => {
                formAgendamentoManual.reset(); 
                
                pacienteDataListManual.innerHTML = ''; 
                listaDePacientesCache.sort((a, b) => a.nome.localeCompare(b.nome)); 
                listaDePacientesCache.forEach(paciente => {
                    const option = document.createElement('option');
                    option.value = paciente.nome; 
                    pacienteDataListManual.appendChild(option);
                });
                
                document.querySelectorAll('input[name="dia-semana"]').forEach(cb => cb.checked = false);

                modalAgendamentoManualContainer.style.display = 'flex';
                inputPacienteManual.focus();
            };
            btnAbrirModalAgendamento.onclick = showAgendamentoManualModal;
            btnAbrirModalAgendamentoHeader.onclick = showAgendamentoManualModal;
            
            modalAgendamentoManualClose.onclick = () => {
                modalAgendamentoManualContainer.style.display = 'none';
            };

            inputDataManual.onchange = () => {
                const dataStr = inputDataManual.value;
                if (dataStr) {
                    document.querySelectorAll('input[name="dia-semana"]').forEach(cb => cb.checked = false);
                    const dataObj = new Date(dataStr + 'T00:00:00'); 
                    const diasRRule = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA'];
                    const diaDaSemana = diasRRule[dataObj.getUTCDay()]; 
                    
                    const checkboxAlvo = document.querySelector(`#form-agendamento-manual input[name="dia-semana"][value="${diaDaSemana}"]`);
                    if (checkboxAlvo) {
                        checkboxAlvo.checked = true;
                    }
                }
            };

            formAgendamentoManual.onsubmit = async (event) => {
                event.preventDefault();

                const nomePaciente = document.getElementById('input-paciente-manual').value;
                const dataStr = document.getElementById('input-data-manual').value;
                const horaStr = document.getElementById('input-hora-manual').value;
                
                const diasSelecionados = [];
                document.querySelectorAll('#form-agendamento-manual input[name="dia-semana"]:checked').forEach(cb => {
                    diasSelecionados.push(cb.value);
                });

                if (!nomePaciente || !dataStr || !horaStr) {
                    showErrorToast("Por favor, preencha todos os campos.");
                    return;
                }

                const pacienteEncontrado = listaDePacientesCache.find(
                    p => p.nome.toLowerCase() === nomePaciente.toLowerCase().trim()
                );

                if (!pacienteEncontrado) {
                    showErrorToast('Paciente n√£o encontrado. Por favor, selecione um nome v√°lido da lista ou cadastre o paciente primeiro.');
                    return;
                }

                const dataInicio = new Date(`${dataStr}T${horaStr}`);
                const dataFim = new Date(dataInicio.getTime() + 55 * 60000); 

                const diasRRule = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA'];
                const diaDaSemanaInicio = diasRRule[dataInicio.getDay()]; 
                if (diasSelecionados.length > 0 && !diasSelecionados.includes(diaDaSemanaInicio)) {
                    diasSelecionados.push(diaDaSemanaInicio);
                }
                
                let rruleStr = null;
                if (diasSelecionados.length > 0) {
                    rruleStr = `FREQ=WEEKLY;BYDAY=${diasSelecionados.join(',')}`;
                }

                const sucesso = await salvarAgendamento(pacienteEncontrado.id, dataInicio, dataFim, rruleStr);
                
                if (sucesso) {
                    modalAgendamentoManualContainer.style.display = 'none'; 
                }
            };


            // --- L√ìGICA DO DASHBOARD ---
            btnBuscarDashboard.onclick = async () => {
                const ano = selectAno.value;
                const mes = selectMes.value;
                loadingDashboard.style.display = 'block';
                dashboardResultados.innerHTML = "";
                try {
                    const response = await fetch(`${API_URL}/dashboard/sessoes-por-mes?ano=${ano}&mes=${mes}`);
                    if (!response.ok) { throw new Error('Erro ao buscar dados.'); }
                    const dados = await response.json();
                    let tabelaHTML = '<table class="modal-table"><tr><th>Paciente</th><th>Total de Sess√µes</th></tr>';
                    if (dados.length === 0) {
                        tabelaHTML = "<p>Nenhuma sess√£o realizada encontrada para este per√≠odo.</p>";
                    } else {
                        dados.forEach(item => {
                            tabelaHTML += `<tr><td>${item.nome_paciente}</td><td>${item.total_sessoes}</td></tr>`;
                        });
                        tabelaHTML += "</table>";
                    }
                    dashboardResultados.innerHTML = tabelaHTML;
                } catch (error) {
                    console.error('Erro no dashboard:', error);
                    dashboardResultados.innerHTML = "<p style='color: red;'>Erro ao carregar dados.</p>";
                } finally {
                    loadingDashboard.style.display = 'none';
                }
            };

            // --- L√ìGICA DA LISTA DE PACIENTES ---
            function abrirListaPacientes() {
                listaPacientesTbody.innerHTML = ""; 
                listaDePacientesCache.sort((a, b) => a.nome.localeCompare(b.nome));

                if (listaDePacientesCache.length === 0) {
                    listaPacientesTbody.innerHTML = "<tr><td colspan='4'>Nenhum paciente cadastrado.</td></tr>";
                } else {
                    listaDePacientesCache.forEach(paciente => {
                        const tr = document.createElement('tr');
                        
                        const tdId = document.createElement('td');
                        tdId.textContent = paciente.id;
                        const tdNome = document.createElement('td');
                        tdNome.textContent = paciente.nome;
                        const tdTel = document.createElement('td');
                        tdTel.textContent = paciente.telefone || 'N/A';
                        
                        const tdAcoes = document.createElement('td');
                        
                        const btnEditar = document.createElement('button');
                        btnEditar.textContent = '‚úèÔ∏è';
                        btnEditar.title = 'Editar Cadastro';
                        btnEditar.className = 'btn-acao btn-acao-edit';
                        btnEditar.onclick = (e) => {
                            e.stopPropagation(); 
                            handleEditarPaciente(paciente);
                        };

                        const btnExcluir = document.createElement('button');
                        btnExcluir.textContent = 'üóëÔ∏è';
                        btnExcluir.title = 'Excluir Paciente';
                        btnExcluir.className = 'btn-acao btn-acao-delete';
                        btnExcluir.onclick = (e) => {
                            e.stopPropagation(); 
                            handleExcluirPaciente(paciente.id, paciente.nome);
                        };
                        
                        const btnProntuario = document.createElement('button');
                        btnProntuario.textContent = 'üìÑ';
                        btnProntuario.title = 'Ver Evolu√ß√µes (Prontu√°rio)';
                        btnProntuario.className = 'btn-acao btn-acao-prontuario';
                        btnProntuario.onclick = (e) => {
                            e.stopPropagation();
                            abrirHistoricoPaciente(paciente); 
                        };

                        tdAcoes.appendChild(btnEditar);
                        tdAcoes.appendChild(btnExcluir);
                        tdAcoes.appendChild(btnProntuario); 
                        
                        tr.appendChild(tdId);
                        tr.appendChild(tdNome);
                        tr.appendChild(tdTel);
                        tr.appendChild(tdAcoes); 
                        
                        listaPacientesTbody.appendChild(tr);
                    });
                }
            };

            // --- FUN√á√ïES DE A√á√ÉO (EDITAR E EXCLUIR) ---

            function handleEditarPaciente(paciente) {
                pacienteIdEmEdicao = paciente.id;
                
                modalTituloPaciente.textContent = `Editando Paciente: ${paciente.nome}`;
                document.getElementById('paciente-nome').value = paciente.nome;
                document.getElementById('paciente-telefone').value = paciente.telefone || '';
                
                if (paciente.data_nascimento && paciente.data_nascimento.includes('T')) {
                     document.getElementById('paciente-nasc').value = paciente.data_nascimento.split('T')[0];
                } else if (paciente.data_nascimento) {
                    document.getElementById('paciente-nasc').value = paciente.data_nascimento;
                } else {
                    document.getElementById('paciente-nasc').value = '';
                }

                document.getElementById('paciente-sexo').value = paciente.sexo || '';
                document.getElementById('paciente-diag').value = paciente.diagnostico_medico || '';
                document.getElementById('paciente-avaliacao').value = paciente.avaliacao || ''; 
                
                modalPacienteContainer.style.display = 'flex';
            }

            async function handleExcluirPaciente(pacienteId, pacienteNome) {
                if (!confirm(`Tem certeza que deseja excluir "${pacienteNome}"?\n\nATEN√á√ÉO: Isso √© permanente e n√£o pode ser desfeito.`)) {
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/pacientes/${pacienteId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        showSuccessToast(`Paciente "${pacienteNome}" exclu√≠do com sucesso.`);
                        listaDePacientesCache = listaDePacientesCache.filter(p => p.id !== pacienteId);
                        abrirListaPacientes(); // Atualiza a tabela
                        calendar.refetchEvents(); 
                    } else {
                        const error = await response.json();
                        console.error('Erro ao excluir:', error);
                        showErrorToast(`Erro ao excluir paciente: ${JSON.stringify(error.detail)}\n\n(Lembre-se: voc√™ n√£o pode excluir um paciente que tenha agendamentos. Exclua-os permanentemente primeiro).`);
                    }
                } catch (error) {
                    console.error('Erro de rede ao excluir:', error);
                    showErrorToast('Erro de conex√£o ao tentar excluir.');
                }
            }


            // --- L√ìGICA DO MODAL HIST√ìRICO DE EVOLU√á√ïES ---
            modalHistoricoClose.onclick = () => modalHistoricoContainer.style.display = 'none';
            
            async function abrirHistoricoPaciente(paciente) {
                historicoNomePaciente.textContent = paciente.nome;
                loadingHistorico.style.display = 'block';
                historicoEvolucoesContent.innerHTML = "";
                
                prontuarioAvaliacao.textContent = paciente.avaliacao || "(Nenhuma avalia√ß√£o registrada)";
                
                modalHistoricoContainer.style.display = 'flex';
                
                try {
                    const response = await fetch(`${API_URL}/pacientes/${paciente.id}/evolucoes`);
                    if (!response.ok) {
                        throw new Error('Erro ao buscar hist√≥rico.');
                    }
                    const evolucoes = await response.json();
                    
                    if (evolucoes.length === 0) {
                        historicoEvolucoesContent.innerHTML = "<p>Nenhuma evolu√ß√£o di√°ria registrada para este paciente.</p>";
                    } else {
                        evolucoes.sort((a, b) => new Date(b.data_criacao) - new Date(a.data_criacao));

                        evolucoes.forEach(evo => {
                            const data = new Date(evo.data_criacao).toLocaleString('pt-BR');
                            const itemHTML = `
                                <div class="evolucao-item">
                                    <div class="evolucao-data">${data}</div>
                                    <div class="evolucao-texto">${evo.texto_evolucao}</div>
                                </div>
                            `;
                            historicoEvolucoesContent.innerHTML += itemHTML;
                        });
                    }
                } catch (error) {
                    console.error('Erro ao buscar hist√≥rico:', error);
                    historicoEvolucoesContent.innerHTML = "<p style='color: red;'>Erro ao carregar hist√≥rico.</p>";
                } finally {
                    loadingHistorico.style.display = 'none';
                }
            }

            // (Fechar Modais ao clicar fora)
            window.onclick = (event) => {
                if (event.target == modalContainer) modalContainer.style.display = 'none';
                if (event.target == modalPacienteContainer) {
                    modalPacienteContainer.style.display = 'none';
                    pacienteIdEmEdicao = null; 
                }
                if (event.target == modalHistoricoContainer) modalHistoricoContainer.style.display = 'none';
                if (event.target == modalNovoAgendamento) {
                    modalNovoAgendamento.style.display = 'none';
                    currentSelectionInfo = null;
                }
                if (event.target == modalAgendamentoManualContainer) {
                    modalAgendamentoManualContainer.style.display = 'none';
                }
            };
        });
    </script>

</body>
</html>