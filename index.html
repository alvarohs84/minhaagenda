<!DOCTYPE html>
<html lang='pt-br'>
<head>
    <meta charset='utf-8' />
    <title>Agenda de Fisioterapia</title>
    
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding: 20px;
        }
        #calendar {
            max-width: 1100px;
            margin: 0 auto;
        }
        .fc-event {
            cursor: pointer;
        }

        /* Cabe√ßalho com bot√µes */
        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1100px;
            margin: 0 auto;
            margin-bottom: 20px;
        }
        .header-controls button { /* Estilo geral para bot√µes no cabe√ßalho */
            font-size: 0.9em;
            padding: 10px 15px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            color: white;
            font-weight: bold;
            margin-left: 10px; /* Espa√ßamento entre bot√µes */
        }
        #btn-abrir-modal-paciente {
            background-color: #17a2b8; /* Ciano */
        }
        
        /* --- NOVO: Bot√£o Dashboard --- */
        #btn-abrir-dashboard {
            background-color: #6f42c1; /* Roxo */
        }
        /* --- FIM NOVO --- */
        

        /* --- CSS DO MODAL (Gen√©rico) --- */
        .modal-container {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            border-radius: 8px;
            padding: 25px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-content h3, .modal-content h4 {
            margin-top: 0;
        }
        .modal-content textarea {
            width: 95%;
            height: 150px;
            font-size: 1.1em;
            margin-top: 10px;
        }
        .modal-content button {
            font-size: 1em;
            padding: 10px 15px;
            margin-top: 15px;
            margin-right: 10px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
        }
        
        #btn-checkin { background-color: #28a745; color: white; }
        #btn-gravar { background-color: #dc3545; color: white; }
        #btn-salvar-evolucao { background-color: #007bff; color: white; }
        #status-gravacao { font-style: italic; color: #555; }

        .modal-content form { 
            display: flex; 
            flex-direction: column; 
        }
        .modal-content form label { 
            margin-top: 15px; 
            font-weight: bold; 
            font-size: 0.9em;
        }
        .modal-content form input,
        .modal-content form select,
        .modal-content form textarea#paciente-diag {
            width: 95%;
            padding: 8px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-top: 5px;
            height: auto;
        }
        #btn-salvar-paciente { 
            background-color: #007bff; 
            color: white; 
            margin-top: 20px;
        }

        /* --- NOVO: Estilos do Dashboard --- */
        #dashboard-filtros {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }
        #dashboard-filtros select, #dashboard-filtros button {
            padding: 8px;
            font-size: 1em;
            margin-top: 0;
        }
        #dashboard-resultados table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        #dashboard-resultados th, #dashboard-resultados td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #dashboard-resultados th {
            background-color: #f2f2f2;
        }
        #loading-dashboard {
            display: none;
            font-style: italic;
        }
        /* --- FIM NOVO --- */

    </style>
</head>
<body>

    <div class="header-controls">
        <h2>Minha Agenda de Fisioterapia</h2>
        <div>
            <button id="btn-abrir-dashboard">Dashboard üìä</button>
            <button id="btn-abrir-modal-paciente">Cadastrar Novo Paciente +</button>
        </div>
    </div>

    <div id='calendar'></div>

    <div id="modal-container" class="modal-container">
        <div class="modal-content">
            <span class="modal-close" id="modal-agendamento-close">&times;</span>
            <h3 id="modal-paciente-nome">Nome do Paciente</h3>
            <p><strong>Diagn√≥stico:</strong> <span id="modal-paciente-diagnostico"></span></p>
            <p><strong>Telefone:</strong> <span id="modal-paciente-telefone"></span></p>
            <p><strong>Status:</strong> <span id="modal-agendamento-status"></span></p>
            <button id="btn-checkin">Fazer Check-in</button>
            <hr style="margin-top: 20px;">
            <h4>Evolu√ß√£o da Sess√£o</h4>
            <textarea id="texto-evolucao" placeholder="Digite ou grave a evolu√ß√£o..."></textarea>
            <p id="status-gravacao"></p>
            <button id="btn-gravar">Gravar üé§</button>
            <button id="btn-salvar-evolucao">Salvar Evolu√ß√£o</button>
        </div>
    </div>
    
    <div id="modal-paciente-container" class="modal-container">
        <div class="modal-content">
            <span class="modal-close" id="modal-paciente-close">&times;</span>
            <h3>Cadastrar Novo Paciente</h3>
            <form id="form-novo-paciente">
                <label for="paciente-nome">Nome Completo:</label>
                <input type="text" id="paciente-nome" required>
                <label for="paciente-telefone">Telefone:</label>
                <input type="text" id="paciente-telefone" placeholder="(XX) 9XXXX-XXXX">
                <label for="paciente-nasc">Data de Nascimento:</label>
                <input type="date" id="paciente-nasc" required>
                <label for="paciente-sexo">Sexo:</label>
                <select id="paciente-sexo" required>
                    <option value="Feminino">Feminino</option>
                    <option value="Masculino">Masculino</option>
                    <option value="Outro">Outro</option>
                </select>
                <label for="paciente-diag">Diagn√≥stico M√©dico:</label>
                <textarea id="paciente-diag" rows="3"></textarea>
                <button type="submit" id="btn-salvar-paciente">Salvar Paciente</button>
            </form>
        </div>
    </div>

    <div id="modal-dashboard-container" class="modal-container">
        <div class="modal-content">
            <span class="modal-close" id="modal-dashboard-close">&times;</span>
            <h3>Dashboard de Sess√µes Realizadas</h3>
            
            <div id="dashboard-filtros">
                <label for="dash-mes">M√™s:</label>
                <select id="dash-mes"></select>
                
                <label for="dash-ano">Ano:</label>
                <select id="dash-ano"></select>
                
                <button id="btn-buscar-dashboard">Buscar</button>
            </div>
            
            <p id="loading-dashboard">Carregando dados...</p>
            
            <div id="dashboard-resultados">
                </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            
            // APONTANDO PARA A SUA API NO RENDER
            const API_URL = 'https://minhaagenda.onrender.com';
            
            // --- Cache de Pacientes ---
            let listaDePacientesCache = [];
            
            // --- Seletores de Elementos (Modal Agendamento) ---
            const modalContainer = document.getElementById('modal-container');
            const modalAgendamentoClose = document.getElementById('modal-agendamento-close');
            let currentAgendamentoId = null; 
            const modalPacienteNome = document.getElementById('modal-paciente-nome');
            const modalPacienteDiagnostico = document.getElementById('modal-paciente-diagnostico');
            const modalPacienteTelefone = document.getElementById('modal-paciente-telefone');
            const modalAgendamentoStatus = document.getElementById('modal-agendamento-status');
            const btnCheckin = document.getElementById('btn-checkin');
            const btnGravar = document.getElementById('btn-gravar');
            const btnSalvarEvolucao = document.getElementById('btn-salvar-evolucao');
            const textoEvolucao = document.getElementById('texto-evolucao');
            const statusGravacao = document.getElementById('status-gravacao');
            
            // --- Seletores de Elementos (Modal Paciente) ---
            const btnAbrirModalPaciente = document.getElementById('btn-abrir-modal-paciente');
            const modalPacienteContainer = document.getElementById('modal-paciente-container');
            const modalPacienteClose = document.getElementById('modal-paciente-close');
            const formNovoPaciente = document.getElementById('form-novo-paciente');

            // --- NOVO: Seletores de Elementos (Modal Dashboard) ---
            const btnAbrirDashboard = document.getElementById('btn-abrir-dashboard');
            const modalDashboardContainer = document.getElementById('modal-dashboard-container');
            const modalDashboardClose = document.getElementById('modal-dashboard-close');
            const selectMes = document.getElementById('dash-mes');
            const selectAno = document.getElementById('dash-ano');
            const btnBuscarDashboard = document.getElementById('btn-buscar-dashboard');
            const loadingDashboard = document.getElementById('loading-dashboard');
            const dashboardResultados = document.getElementById('dashboard-resultados');
            // --- FIM NOVO ---

            // --- L√ìGICA DO CALEND√ÅRIO ---
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek', 
                locale: 'pt-br',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                buttonText: {
                    today: 'Hoje',
                    month: 'M√™s',
                    week: 'Semana',
                    day: 'Dia'
                },
                selectable: true,
                select: handleSelectTime,
                eventClick: handleEventClick,
                events: `${API_URL}/agendamentos`,
                eventDataTransform: function(apiEvent) {
                    return {
                        id: apiEvent.id,
                        title: `${apiEvent.paciente.nome} (${apiEvent.status})`, 
                        start: apiEvent.data_hora_inicio,
                        end: apiEvent.data_hora_fim,
                        extendedProps: { apiEvent: apiEvent },
                        color: apiEvent.status === 'Presente' ? '#2ca02c' : '#3788d8'
                    };
                }
            });

            // --- FUN√á√ïES DE INICIALIZA√á√ÉO ---
            
            // Carrega o cache de pacientes
            async function carregarPacientes() {
                try {
                    const response = await fetch(`${API_URL}/pacientes`);
                    if (response.ok) {
                        listaDePacientesCache = await response.json();
                        console.log('Cache de pacientes carregado:', listaDePacientesCache);
                    } else { console.error('Erro ao carregar pacientes.'); }
                } catch (error) { console.error('Erro de rede ao carregar pacientes:', error); }
            }

            // --- NOVO: Preenche os filtros de data do Dashboard ---
            function popularFiltrosDashboard() {
                const hoje = new Date();
                const mesAtual = hoje.getMonth(); // 0-11
                const anoAtual = hoje.getFullYear();

                const nomesMeses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                
                // Popula Meses
                nomesMeses.forEach((nome, index) => {
                    const option = new Option(nome, index + 1); // Valor √© 1-12
                    selectMes.add(option);
                });
                selectMes.value = mesAtual + 1; // Define o m√™s atual

                // Popula Anos (Ano atual + √∫ltimos 5 anos)
                for (let i = 0; i < 5; i++) {
                    const ano = anoAtual - i;
                    const option = new Option(ano, ano);
                    selectAno.add(option);
                }
                selectAno.value = anoAtual;
            }
            // --- FIM NOVO ---
            
            // Inicializa a aplica√ß√£o
            carregarPacientes().then(() => {
                calendar.render();
                popularFiltrosDashboard();
            });

            // --- FUN√á√ïES DO CALEND√ÅRIO ---
            
            // (CRIAR AGENDAMENTO)
            async function handleSelectTime(selectionInfo) {
                let nomePaciente = prompt('Digite o NOME do paciente para agendar:');
                if (!nomePaciente) return;

                const pacienteEncontrado = listaDePacientesCache.find(
                    p => p.nome.toLowerCase() === nomePaciente.trim().toLowerCase()
                );
                if (!pacienteEncontrado) {
                    alert('Paciente n√£o encontrado. Verifique o nome ou cadastre-o primeiro.');
                    return;
                }
                
                const novoAgendamento = {
                    paciente_id: pacienteEncontrado.id,
                    data_hora_inicio: selectionInfo.start.toISOString(),
                    data_hora_fim: selectionInfo.end.toISOString()
                };

                try {
                    const response = await fetch(`${API_URL}/agendamentos`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(novoAgendamento)
                    });
                    if (response.ok) {
                        alert('Agendamento criado com sucesso!');
                        calendar.refetchEvents();
                    } else {
                        const error = await response.json();
                        alert(`Erro ao agendar: ${error.detail}`);
                    }
                } catch (error) { console.error('Erro de rede:', error); }
            }

            // (ABRIR MODAL DE DETALHES)
            function handleEventClick(clickInfo) {
                const apiEvent = clickInfo.event.extendedProps.apiEvent;
                currentAgendamentoId = apiEvent.id; 
                modalPacienteNome.textContent = apiEvent.paciente.nome;
                modalPacienteDiagnostico.textContent = apiEvent.paciente.diagnostico_medico || 'Nenhum';
                modalPacienteTelefone.textContent = apiEvent.paciente.telefone;
                modalAgendamentoStatus.textContent = apiEvent.status;
                textoEvolucao.value = '';
                statusGravacao.textContent = '';
                
                if (apiEvent.status === 'Agendado') {
                    btnCheckin.disabled = false;
                    btnCheckin.style.display = 'inline-block';
                } else {
                    btnCheckin.disabled = true;
                    btnCheckin.style.display = 'none';
                }
                modalContainer.style.display = 'flex';
            }

            // --- L√ìGICA DO MODAL DE AGENDAMENTO (CHECK-IN, VOZ, SALVAR) ---
            modalAgendamentoClose.onclick = () => modalContainer.style.display = 'none';
            btnCheckin.onclick = async () => {
                try {
                    const response = await fetch(`${API_URL}/agendamentos/${currentAgendamentoId}/checkin`, { method: 'POST' });
                    if (response.ok) {
                        alert('Check-in realizado!');
                        modalContainer.style.display = 'none';
                        calendar.refetchEvents();
                    } else {
                        const error = await response.json();
                        alert(`Erro no check-in: ${error.detail}`);
                    }
                } catch (error) { console.error('Erro de rede:', error); }
            };
            btnSalvarEvolucao.onclick = async () => {
                const texto = textoEvolucao.value;
                if (!texto) { alert('O campo de evolu√ß√£o est√° vazio.'); return; }
                try {
                    const response = await fetch(`${API_URL}/agendamentos/${currentAgendamentoId}/evolucoes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ texto_evolucao: texto })
                    });
                    if (response.ok) {
                        alert('Evolu√ß√£o salva com sucesso!');
                        modalContainer.style.display = 'none';
                    } else {
                        const error = await response.json();
                        alert(`Erro ao salvar evolu√ß√£o: ${error.detail}`);
                    }
                } catch (error) { console.error('Erro de rede:', error); }
            };

            // --- L√ìGICA DA API DE VOZ ---
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'pt-BR';
                recognition.interimResults = true;
                recognition.continuous = true;
                let finalTranscript = '';
                recognition.onstart = () => {
                    finalTranscript = textoEvolucao.value;
                    statusGravacao.textContent = 'Ouvindo... Fale agora.';
                    btnGravar.textContent = 'Parar ‚èπÔ∏è';
                    btnGravar.style.backgroundColor = '#6c757d';
                };
                recognition.onend = () => {
                    statusGravacao.textContent = 'Grava√ß√£o parada.';
                    btnGravar.textContent = 'Gravar üé§';
                    btnGravar.style.backgroundColor = '#dc3545';
                };
                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += (finalTranscript.length > 0 ? ' ' : '') + transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    textoEvolucao.value = finalTranscript + (interimTranscript ? ' (' + interimTranscript + ')' : '');
                };
                recognition.onerror = (event) => { statusGravacao.textContent = 'Erro na grava√ß√£o: ' + event.error; };
            } else {
                statusGravacao.textContent = 'Seu navegador n√£o suporta a API de Voz.';
                btnGravar.disabled = true;
            }
            btnGravar.onclick = () => {
                if (btnGravar.textContent.includes('Gravar')) {
                    recognition.start();
                } else {
                    recognition.stop();
                }
            };
            
            // --- L√ìGICA DO MODAL DE CADASTRO DE PACIENTE ---
            btnAbrirModalPaciente.onclick = () => {
                formNovoPaciente.reset();
                modalPacienteContainer.style.display = 'flex';
            };
            modalPacienteClose.onclick = () => modalPacienteContainer.style.display = 'none';
            formNovoPaciente.onsubmit = async (event) => {
                event.preventDefault(); 
                const novoPaciente = {
                    nome: document.getElementById('paciente-nome').value,
                    telefone: document.getElementById('paciente-telefone').value,
                    data_nascimento: document.getElementById('paciente-nasc').value,
                    sexo: document.getElementById('paciente-sexo').value,
                    diagnostico_medico: document.getElementById('paciente-diag').value
                };
                if (!novoPaciente.nome || !novoPaciente.data_nascimento) {
                    alert('Nome e Data de Nascimento s√£o obrigat√≥rios.');
                    return;
                }
                try {
                    const response = await fetch(`${API_URL}/pacientes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(novoPaciente)
                    });
                    if (response.ok) {
                        const pacienteCriado = await response.json();
                        alert(`Paciente "${pacienteCriado.nome}" cadastrado com sucesso! \nNovo ID: ${pacienteCriado.id}`);
                        formNovoPaciente.reset();
                        modalPacienteContainer.style.display = 'none';
                        listaDePacientesCache.push(pacienteCriado);
                    } else {
                        const error = await response.json();
                        alert(`Erro ao cadastrar: ${error.detail}`);
                    }
                } catch (error) {
                    console.error('Erro de rede:', error);
                    alert('Erro ao conectar com a API.');
                }
            };

            // --- NOVO: L√ìGICA DO MODAL DASHBOARD ---
            
            // (Abrir Modal)
            btnAbrirDashboard.onclick = () => {
                dashboardResultados.innerHTML = ""; // Limpa resultados anteriores
                modalDashboardContainer.style.display = 'flex';
            };

            // (Fechar Modal)
            modalDashboardClose.onclick = () => modalDashboardContainer.style.display = 'none';
            
            // (Buscar Dados)
            btnBuscarDashboard.onclick = async () => {
                const ano = selectAno.value;
                const mes = selectMes.value;
                
                loadingDashboard.style.display = 'block'; // Mostra "Carregando..."
                dashboardResultados.innerHTML = ""; // Limpa tabela antiga
                
                try {
                    // Chama o novo endpoint da API
                    const response = await fetch(`${API_URL}/dashboard/sessoes-por-mes?ano=${ano}&mes=${mes}`);
                    
                    if (!response.ok) {
                        throw new Error('Erro ao buscar dados do dashboard.');
                    }
                    
                    const dados = await response.json();
                    
                    // Constr√≥i a tabela de resultados
                    if (dados.length === 0) {
                        dashboardResultados.innerHTML = "<p>Nenhuma sess√£o realizada encontrada para este per√≠odo.</p>";
                    } else {
                        let tabelaHTML = "<table><tr><th>Paciente</th><th>Total de Sess√µes</th></tr>";
                        dados.forEach(item => {
                            tabelaHTML += `<tr><td>${item.nome_paciente}</td><td>${item.total_sessoes}</td></tr>`;
                        });
                        tabelaHTML += "</table>";
                        dashboardResultados.innerHTML = tabelaHTML;
                    }

                } catch (error) {
                    console.error('Erro no dashboard:', error);
                    dashboardResultados.innerHTML = "<p style='color: red;'>Erro ao carregar dados.</p>";
                } finally {
                    loadingDashboard.style.display = 'none'; // Esconde "Carregando..."
                }
            };
            // --- FIM NOVO ---


            // (Fechar Modais ao clicar fora)
            window.onclick = (event) => {
                if (event.target == modalContainer) {
                    modalContainer.style.display = 'none';
                }
                if (event.target == modalPacienteContainer) {
                    modalPacienteContainer.style.display = 'none';
                }
                // NOVO:
                if (event.target == modalDashboardContainer) {
                    modalDashboardContainer.style.display = 'none';
                }
            };
        });
    </script>

</body>
</html>